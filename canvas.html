<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vintage Mathematical OS</title>
    <style>
        /* Base System Styling */
        :root {
            --main-bg: #000000;
            --main-text: #33ff33;
            --main-border: #33ff33;
            --terminal-bg: #111111;
            --button-bg: #333333;
            --highlight: #00aa00;
            --cell-default-bg: #222222;
            --cell-default-text: #33ff33;
            --window-header: #005500;
            --window-body: rgba(0, 17, 0, 0.9);
            --icon-bg: #001100;
            --tooltip-bg: #001100;
            --tooltip-border: #00aa00;
            --scrollbar-thumb: #00aa00;
            --scrollbar-track: #001100;
            --menu-bg: rgba(0, 17, 0, 0.95);
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: var(--main-bg);
            color: var(--main-text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--highlight);
        }
        
        /* OS Layout */
        .os-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .titlebar {
            height: 24px;
            background-color: var(--terminal-bg);
            border-bottom: 1px solid var(--main-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            user-select: none;
        }
        
        .taskbar {
            height: 30px;
            background-color: var(--terminal-bg);
            border-top: 1px solid var(--main-border);
            display: flex;
            align-items: center;
            padding: 0 10px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .desktop {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--main-bg);
            background-image: 
                radial-gradient(var(--main-border) 1px, transparent 1px),
                radial-gradient(var(--main-border) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
            background-attachment: fixed;
            opacity: 0.7;
        }
        
        /* Desktop Icons */
        .desktop-icons {
            display: grid;
            grid-template-columns: repeat(auto-fill, 80px);
            grid-gap: 20px;
            padding: 20px;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .desktop-icon {
            width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
        }
        
        .desktop-icon:hover {
            background-color: rgba(0, 170, 0, 0.3);
        }
        
        .icon-image {
            width: 48px;
            height: 48px;
            background-color: var(--icon-bg);
            border: 1px solid var(--main-border);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--main-text);
        }
        
        .icon-text {
            text-align: center;
            font-size: 12px;
            word-wrap: break-word;
            max-width: 80px;
            text-shadow: 1px 1px 2px black;
        }
        
        /* Windows */
        .window {
            position: absolute;
            background-color: var(--window-body);
            border: 1px solid var(--main-border);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            min-width: 200px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            border-radius: 3px;
        }
        
        .window-header {
            background-color: var(--window-header);
            color: var(--main-text);
            padding: 5px 10px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .window-title {
            margin: 0;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .window-controls {
            display: flex;
            gap: 5px;
        }
        
        .window-control {
            width: 14px;
            height: 14px;
            text-align: center;
            line-height: 14px;
            cursor: pointer;
            font-size: 10px;
            border-radius: 2px;
            border: 1px solid var(--main-text);
        }
        
        .window-control:hover {
            background-color: var(--highlight);
        }
        
        .window-content {
            flex: 1;
            overflow: auto;
            padding: 10px;
        }
        
        /* Main Menu */
        .main-menu {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 200px;
            background-color: var(--menu-bg);
            border: 1px solid var(--main-border);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            z-index: 1000;
            display: none;
        }
        
        .menu-item {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 170, 0, 0.3);
        }
        
        .menu-item:hover {
            background-color: var(--highlight);
            color: #000;
        }
        
        /* Start Button */
        .start-button {
            background-color: var(--button-bg);
            color: var(--main-text);
            border: 1px solid var(--main-border);
            padding: 2px 10px;
            cursor: pointer;
            margin-right: 10px;
            height: 22px;
            display: flex;
            align-items: center;
        }
        
        .start-button:hover {
            background-color: var(--highlight);
            color: #000;
        }
        
        /* Task Button */
        .task-button {
            background-color: var(--button-bg);
            color: var(--main-text);
            border: 1px solid var(--main-border);
            padding: 2px 10px;
            cursor: pointer;
            margin-right: 5px;
            height: 22px;
            display: flex;
            align-items: center;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        .task-button.active {
            background-color: var(--highlight);
            color: #000;
        }
        
        .task-button:hover:not(.active) {
            background-color: rgba(0, 170, 0, 0.5);
        }
        
        /* System Tray */
        .system-tray {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 10px;
            padding-left: 10px;
            border-left: 1px solid var(--main-border);
        }
        
        .tray-icon {
            width: 16px;
            height: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* System Clock */
        .system-clock {
            font-size: 12px;
            padding: 0 5px;
            user-select: none;
        }
        
        /* Context Menu */
        .context-menu {
            position: absolute;
            background-color: var(--menu-bg);
            border: 1px solid var(--main-border);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            z-index: 1000;
            display: none;
            min-width: 150px;
        }
        
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 170, 0, 0.3);
        }
        
        .context-menu-item:hover {
            background-color: var(--highlight);
            color: #000;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background-color: var(--tooltip-bg);
            border: 1px solid var(--tooltip-border);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            z-index: 1001;
            display: none;
            pointer-events: none;
            max-width: 250px;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--window-body);
            border: 1px solid var(--main-border);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--main-border);
        }
        
        .modal-title {
            margin: 0;
            font-size: 18px;
        }
        
        .modal-close {
            cursor: pointer;
            font-size: 18px;
        }
        
        /* Form Elements */
        input, select, textarea, button {
            background-color: var(--terminal-bg);
            color: var(--main-text);
            border: 1px solid var(--main-border);
            padding: 5px 10px;
            margin: 5px 0;
            font-family: 'Courier New', monospace;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--highlight);
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        
        button {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background-color: var(--highlight);
            color: #000;
        }
        
        /* Form Layout */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        /* File Browser */
        .file-browser {
            border: 1px solid var(--main-border);
            height: 250px;
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
        }
        
        .file-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .file-item:hover {
            background-color: rgba(0, 170, 0, 0.3);
        }
        
        .file-item.selected {
            background-color: rgba(0, 170, 0, 0.5);
        }
        
        .file-icon {
            margin-right: 10px;
            font-size: 14px;
        }
        
        /* Grid System */
        .grid-container {
            border: 1px solid var(--main-border);
            overflow: auto;
            flex: 1;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            grid-gap: 1px;
            background-color: var(--main-border);
            padding: 1px;
            min-width: 100%;
        }
        
        .cell {
            background-color: var(--cell-default-bg);
            color: var(--cell-default-text);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            font-size: 12px;
        }
        
        .cell.split {
            padding: 0;
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            grid-gap: 1px;
            background-color: var(--main-border);
        }
        
        .sub-cell {
            background-color: var(--cell-default-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 20px;
            text-align: center;
            cursor: pointer;
            padding: 2px;
        }

        /* Code Editor */
        .code-editor {
            width: 100%;
            height: 200px;
            font-family: monospace;
            background-color: #001100;
            color: var(--main-text);
            border: 1px solid var(--main-border);
            resize: vertical;
            padding: 10px;
            tab-size: 4;
            line-height: 1.5;
        }
        
        /* File Tree */
        .file-tree {
            border: 1px solid var(--main-border);
            background-color: rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            padding: 5px;
        }
        
        .tree-item {
            margin: 2px 0;
            padding: 3px 5px;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
        }
        
        .tree-item:hover {
            background-color: rgba(0, 170, 0, 0.3);
        }
        
        .tree-toggle {
            width: 15px;
            height: 15px;
            text-align: center;
            line-height: 15px;
            margin-right: 5px;
        }
        
        .tree-children {
            padding-left: 20px;
        }
        
        /* CRT screen effect */
        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            z-index: 9999;
            opacity: 0.2;
            pointer-events: none;
        }
        
        .scanline {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(51, 255, 51, 0.1) 50%, 
                transparent 100%);
            animation: scanline 10s linear infinite;
            opacity: 0.3;
            pointer-events: none;
            z-index: 9998;
        }
        
        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(100vh); }
        }

        /* Terminal */
        .terminal {
            background-color: #000;
            color: var(--main-text);
            font-family: 'Courier New', monospace;
            padding: 10px;
            overflow-y: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .terminal-output {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        
        .terminal-input-line {
            display: flex;
            align-items: center;
        }
        
        .terminal-prompt {
            margin-right: 5px;
        }
        
        .terminal-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--main-text);
            font-family: inherit;
            padding: 0;
            font-size: inherit;
        }
        
        .terminal-input:focus {
            outline: none;
            box-shadow: none;
        }

        /* Loader */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid var(--main-border);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .desktop-icons {
                grid-template-columns: repeat(auto-fill, 70px);
                grid-gap: 10px;
            }
            
            .desktop-icon {
                width: 70px;
            }
            
            .icon-image {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .icon-text {
                font-size: 11px;
                max-width: 70px;
            }
            
            .window {
                width: 90% !important;
                height: 80% !important;
                top: 10% !important;
                left: 5% !important;
            }
        }
    </style>
</head>
<body>
    <!-- CRT screen effect -->
    <div class="crt-overlay"></div>
    <div class="scanline"></div>

    <div class="os-container">
        <div class="titlebar">
            <div class="window-title">Vintage Mathematical OS</div>
            <div class="system-tray">
                <div class="system-clock" id="systemClock">00:00:00</div>
            </div>
        </div>
        
        <div class="desktop" id="desktop">
            <div class="desktop-icons" id="desktopIcons">
                <!-- Desktop icons will be generated here -->
            </div>
        </div>
        
        <div class="taskbar">
            <div class="start-button" id="startButton">START</div>
            <div id="taskbarButtons"></div>
            <div class="system-tray">
                <div class="tray-icon" id="systemTrayIcon" title="System Status">‚óè</div>
            </div>
        </div>
    </div>
    
    <!-- Main Menu -->
    <div class="main-menu" id="mainMenu">
        <div class="menu-item" id="menuApps">Apps</div>
        <div class="menu-item" id="menuFileManager">File Manager</div>
        <div class="menu-item" id="menuInstallApp">Install App</div>
        <div class="menu-item" id="menuSystemSettings">System Settings</div>
        <div class="menu-item" id="menuTerminal">Terminal</div>
        <div class="menu-item" id="menuAbout">About</div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="desktopContextMenu">
        <div class="context-menu-item" id="ctxNewFolder">New Folder</div>
        <div class="context-menu-item" id="ctxRefresh">Refresh</div>
        <div class="context-menu-item" id="ctxSystemInfo">System Info</div>
        <div class="context-menu-item" id="ctxSettings">Settings</div>
    </div>
    
    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>
    
    <!-- App Installation Modal -->
    <div class="modal" id="installAppModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Install App</h3>
                <span class="modal-close" id="closeInstallAppModal">√ó</span>
            </div>
            <div class="form-group">
                <label for="appJsonFile">Select app JSON file:</label>
                <input type="file" id="appJsonFile" accept=".json">
            </div>
            <div class="form-group">
                <label>Or paste app JSON:</label>
                <textarea id="appJsonInput" class="code-editor" placeholder='{"id": "app-id", "name": "App Name", "version": "1.0", ...}'></textarea>
            </div>
            <button id="installAppBtn">Install App</button>
        </div>
    </div>
    
    <!-- System Settings Modal -->
    <div class="modal" id="systemSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">System Settings</h3>
                <span class="modal-close" id="closeSystemSettingsModal">√ó</span>
            </div>
            <div class="form-group">
                <label for="settingTheme">Theme:</label>
                <select id="settingTheme">
                    <option value="default">Default (Green)</option>
                    <option value="blue">Blue</option>
                    <option value="amber">Amber</option>
                    <option value="pink">Pink</option>
                </select>
            </div>
            <div class="form-group">
                <label for="settingFontSize">Font Size:</label>
                <input type="range" id="settingFontSize" min="8" max="20" step="1" value="12">
                <span id="fontSizeValue">12px</span>
            </div>
            <div class="form-group">
                <label for="settingAutoSave">Auto Save Interval (seconds):</label>
                <input type="number" id="settingAutoSave" min="0" max="3600" step="10" value="60">
                <span class="help-text">0 to disable</span>
            </div>
            <div class="form-group">
                <label>Export System Configuration:</label>
                <button id="exportConfigBtn">Export JSON</button>
            </div>
            <div class="form-group">
                <label>Import System Configuration:</label>
                <input type="file" id="importConfigFile" accept=".json">
            </div>
            <div class="form-group">
                <button id="resetSystemBtn">Reset System</button>
                <span class="help-text">Warning: This will remove all apps and data</span>
            </div>
            <button id="saveSettingsBtn">Save Settings</button>
        </div>
    </div>
    
    <!-- About Modal -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">About Vintage Mathematical OS</h3>
                <span class="modal-close" id="closeAboutModal">√ó</span>
            </div>
            <p>Vintage Mathematical OS v1.0</p>
            <p>A client-side web operating system for mathematical applications.</p>
            <p>Features:</p>
            <ul>
                <li>Modular app system with JSON configuration</li>
                <li>Local file system using browser storage</li>
                <li>Custom mathematical applications</li>
                <li>No server dependencies - everything runs in your browser</li>
            </ul>
            <p>¬© 2025 Vintage Software Systems</p>
        </div>
    </div>

    <script>
        /**
         * Vintage Mathematical OS - Core System
         * A client-side web operating system with modular app support
         */
        
        // Global system object
        const VintageOS = {
            version: '1.0',
            name: 'Vintage Mathematical OS',
            
            // System state
            state: {
                runningApps: {},
                windows: {},
                files: {},
                nextWindowId: 1,
                activeWindow: null,
                systemStartTime: Date.now(),
                lastSaveTime: Date.now()
            },
            
            // System configuration
            config: {
                theme: 'default',
                fontSize: 12,
                autoSaveInterval: 60, // seconds, 0 to disable
                installedApps: [],
                desktopIcons: ['mathematicalSandbox', 'fileManager', 'appStore', 'terminal', 'settings'],
                systemReservedApps: ['mathematicalSandbox', 'fileManager', 'appStore', 'terminal', 'settings']
            },
            
            // Built-in apps registry
            builtInApps: {},
            
            // Initialize the system
            init: function() {
                console.log('Initializing Vintage Mathematical OS...');
                
                // Load configuration from localStorage
                this.loadSystemConfig();
                
                // Initialize file system
                this.fs.init();
                
                // Initialize desktop
                this.desktop.init();
                
                // Initialize window manager
                this.windowManager.init();
                
                // Initialize event handlers
                this.initEventHandlers();
                
                // Start system clock
                this.startSystemClock();
                
                // Register built-in apps
                this.registerBuiltInApps();
                
                // Apply theme
                this.applyTheme(this.config.theme);
                
                // Set up auto-save if enabled
                if (this.config.autoSaveInterval > 0) {
                    setInterval(() => this.saveSystemState(), this.config.autoSaveInterval * 1000);
                }
                
                console.log('System initialized');
            },
            
            // Initialize event handlers
            initEventHandlers: function() {
                // Start button
                document.getElementById('startButton').addEventListener('click', () => {
                    const menu = document.getElementById('mainMenu');
                    if (menu.style.display === 'block') {
                        menu.style.display = 'none';
                    } else {
                        menu.style.display = 'block';
                    }
                });
                
                // Main menu items
                document.getElementById('menuApps').addEventListener('click', () => {
                    this.appStore.openAppLauncher();
                    document.getElementById('mainMenu').style.display = 'none';
                });
                
                document.getElementById('menuFileManager').addEventListener('click', () => {
                    this.launchApp('fileManager');
                    document.getElementById('mainMenu').style.display = 'none';
                });
                
                document.getElementById('menuInstallApp').addEventListener('click', () => {
                    document.getElementById('mainMenu').style.display = 'none';
                    document.getElementById('installAppModal').style.display = 'flex';
                });
                
                document.getElementById('menuSystemSettings').addEventListener('click', () => {
                    document.getElementById('mainMenu').style.display = 'none';
                    this.openSystemSettings();
                });
                
                document.getElementById('menuTerminal').addEventListener('click', () => {
                    this.launchApp('terminal');
                    document.getElementById('mainMenu').style.display = 'none';
                });
                
                document.getElementById('menuAbout').addEventListener('click', () => {
                    document.getElementById('mainMenu').style.display = 'none';
                    document.getElementById('aboutModal').style.display = 'flex';
                });
                
                // Desktop context menu
                document.getElementById('desktop').addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const menu = document.getElementById('desktopContextMenu');
                    menu.style.left = `${e.pageX}px`;
                    menu.style.top = `${e.pageY}px`;
                    menu.style.display = 'block';
                });
                
                // Context menu items
                document.getElementById('ctxNewFolder').addEventListener('click', () => {
                    this.fs.createFolder('/Desktop', 'New Folder');
                    document.getElementById('desktopContextMenu').style.display = 'none';
                    this.desktop.refresh();
                });
                
                document.getElementById('ctxRefresh').addEventListener('click', () => {
                    this.desktop.refresh();
                    document.getElementById('desktopContextMenu').style.display = 'none';
                });
                
                document.getElementById('ctxSystemInfo').addEventListener('click', () => {
                    this.showSystemInfo();
                    document.getElementById('desktopContextMenu').style.display = 'none';
                });
                
                document.getElementById('ctxSettings').addEventListener('click', () => {
                    this.openSystemSettings();
                    document.getElementById('desktopContextMenu').style.display = 'none';
                });
                
                // Close context menu on click elsewhere
                document.addEventListener('click', () => {
                    document.getElementById('desktopContextMenu').style.display = 'none';
                    document.getElementById('mainMenu').style.display = 'none';
                });
                
                // App installation modal
                document.getElementById('closeInstallAppModal').addEventListener('click', () => {
                    document.getElementById('installAppModal').style.display = 'none';
                });
                
                document.getElementById('installAppBtn').addEventListener('click', () => {
                    this.installAppFromModal();
                });
                
                // System settings modal
                document.getElementById('closeSystemSettingsModal').addEventListener('click', () => {
                    document.getElementById('systemSettingsModal').style.display = 'none';
                });
                
                document.getElementById('settingFontSize').addEventListener('input', function() {
                    document.getElementById('fontSizeValue').textContent = `${this.value}px`;
                });
                
                document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                    this.saveSystemSettings();
                });
                
                document.getElementById('exportConfigBtn').addEventListener('click', () => {
                    this.exportSystemConfig();
                });
                
                document.getElementById('importConfigFile').addEventListener('change', (e) => {
                    this.importSystemConfig(e);
                });
                
                document.getElementById('resetSystemBtn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset the system? All apps and data will be lost.')) {
                        this.resetSystem();
                    }
                });
                
                // About modal
                document.getElementById('closeAboutModal').addEventListener('click', () => {
                    document.getElementById('aboutModal').style.display = 'none';
                });
                
                // Prevent default context menu
                document.addEventListener('contextmenu', (e) => {
                    if (e.target.classList.contains('desktop') || e.target.classList.contains('desktop-icons')) {
                        e.preventDefault();
                    }
                });
            },
            
            // Start system clock
            startSystemClock: function() {
                const updateClock = () => {
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const seconds = now.getSeconds().toString().padStart(2, '0');
                    document.getElementById('systemClock').textContent = `${hours}:${minutes}:${seconds}`;
                };
                
                updateClock();
                setInterval(updateClock, 1000);
            },
            
            // Register built-in apps
            registerBuiltInApps: function() {
                // Mathematical Sandbox
                this.builtInApps.mathematicalSandbox = {
                    id: 'mathematicalSandbox',
                    name: 'Mathematical Sandbox',
                    version: '1.0',
                    icon: 'M¬≤',
                    description: 'A grid-based environment for mathematical exploration',
                    author: 'System',
                    type: 'system',
                    launch: function() {
                        return VintageOS.apps.mathematicalSandbox.init();
                    }
                };
                
                // File Manager
                this.builtInApps.fileManager = {
                    id: 'fileManager',
                    name: 'File Manager',
                    version: '1.0',
                    icon: 'üìÇ',
                    description: 'Manage files and folders in the system',
                    author: 'System',
                    type: 'system',
                    launch: function() {
                        return VintageOS.apps.fileManager.init();
                    }
                };
                
                // App Store
                this.builtInApps.appStore = {
                    id: 'appStore',
                    name: 'App Store',
                    version: '1.0',
                    icon: 'üõí',
                    description: 'Install and manage applications',
                    author: 'System',
                    type: 'system',
                    launch: function() {
                        return VintageOS.appStore.openAppLauncher();
                    }
                };
                
                // Terminal
                this.builtInApps.terminal = {
                    id: 'terminal',
                    name: 'Terminal',
                    version: '1.0',
                    icon: '>_',
                    description: 'Command-line interface for the system',
                    author: 'System',
                    type: 'system',
                    launch: function() {
                        return VintageOS.apps.terminal.init();
                    }
                };
                
                // Settings
                this.builtInApps.settings = {
                    id: 'settings',
                    name: 'Settings',
                    version: '1.0',
                    icon: '‚öôÔ∏è',
                    description: 'System settings and configuration',
                    author: 'System',
                    type: 'system',
                    launch: function() {
                        return VintageOS.openSystemSettings();
                    }
                };
            },
            
            // Launch an app
            launchApp: function(appId) {
                console.log(`Launching app: ${appId}`);
                
                // Check if it's a built-in app
                if (this.builtInApps[appId]) {
                    return this.builtInApps[appId].launch();
                }
                
                // Check if it's an installed custom app
                const app = this.config.installedApps.find(app => app.id === appId);
                if (app) {
                    return this.launchCustomApp(app);
                }
                
                console.error(`App not found: ${appId}`);
                return false;
            },
            
            // Launch a custom app
            launchCustomApp: function(app) {
                console.log(`Launching custom app: ${app.id}`);
                
                try {
                    // Create a window for the app
                    const windowId = this.windowManager.createWindow(app.name, app.id);
                    
                    // Store reference to the running app
                    this.state.runningApps[app.id] = {
                        app: app,
                        windowId: windowId
                    };
                    
                    // Get the window content element
                    const windowContent = document.getElementById(`window-content-${windowId}`);
                    
                    // Create a safe execution environment for the app
                    const appInstance = {
                        id: app.id,
                        name: app.name,
                        version: app.version,
                        windowId: windowId,
                        rootElement: windowContent,
                        
                        // Safe API for the app to use
                        api: {
                            // File system operations
                            fs: {
                                readFile: (path) => VintageOS.fs.readFile(path),
                                writeFile: (path, content) => VintageOS.fs.writeFile(path, content),
                                listFiles: (path) => VintageOS.fs.listFiles(path),
                                createFolder: (path, name) => VintageOS.fs.createFolder(path, name),
                                deleteFile: (path) => VintageOS.fs.deleteFile(path),
                                fileExists: (path) => VintageOS.fs.fileExists(path)
                            },
                            
                            // UI operations
                            ui: {
                                showNotification: (message) => VintageOS.showNotification(message),
                                prompt: (message, defaultValue) => prompt(message, defaultValue),
                                confirm: (message) => confirm(message),
                                alert: (message) => alert(message)
                            },
                            
                            // App operations
                            getAppInfo: () => ({
                                id: app.id,
                                name: app.name,
                                version: app.version,
                                author: app.author
                            }),
                            
                            // Storage operations
                            storage: {
                                get: (key) => {
                                    const storageKey = `app_${app.id}_${key}`;
                                    const value = localStorage.getItem(storageKey);
                                    try {
                                        return value ? JSON.parse(value) : null;
                                    } catch (e) {
                                        return value;
                                    }
                                },
                                set: (key, value) => {
                                    const storageKey = `app_${app.id}_${key}`;
                                    localStorage.setItem(storageKey, JSON.stringify(value));
                                },
                                remove: (key) => {
                                    const storageKey = `app_${app.id}_${key}`;
                                    localStorage.removeItem(storageKey);
                                }
                            }
                        }
                    };
                    
                    // Execute the app's code in a try-catch block for safety
                    try {
                        const appFunction = new Function('app', app.code);
                        appFunction(appInstance);
                        return true;
                    } catch (error) {
                        console.error(`Error executing app ${app.id}:`, error);
                        windowContent.innerHTML = `
                            <div style="color: red; padding: 20px;">
                                <h3>Error launching app</h3>
                                <p>${error.message}</p>
                                <pre>${error.stack}</pre>
                            </div>
                        `;
                        return false;
                    }
                } catch (error) {
                    console.error(`Error launching app ${app.id}:`, error);
                    this.showNotification(`Failed to launch app: ${app.name}`);
                    return false;
                }
            },
            
            // Window Manager
            windowManager: {
                init: function() {
                    // Set up event delegation for window actions
                    document.addEventListener('mousedown', (e) => {
                        // Check if clicked on a window header
                        if (e.target.closest('.window-header')) {
                            const windowElement = e.target.closest('.window');
                            if (windowElement) {
                                const windowId = windowElement.dataset.windowId;
                                VintageOS.windowManager.activateWindow(windowId);
                                
                                // If it's not a control button, start dragging
                                if (!e.target.closest('.window-control')) {
                                    this.startDragging(windowId, e);
                                }
                            }
                        }
                    });
                },
                
                createWindow: function(title, appId, width = 600, height = 400) {
                    const windowId = VintageOS.state.nextWindowId++;
                    
                    // Create window element
                    const windowElement = document.createElement('div');
                    windowElement.className = 'window';
                    windowElement.dataset.windowId = windowId;
                    windowElement.dataset.appId = appId;
                    windowElement.style.width = `${width}px`;
                    windowElement.style.height = `${height}px`;
                    windowElement.style.left = `${50 + (windowId % 10) * 20}px`;
                    windowElement.style.top = `${50 + (windowId % 10) * 20}px`;
                    windowElement.style.zIndex = 100 + windowId;
                    
                    // Create window header
                    const windowHeader = document.createElement('div');
                    windowHeader.className = 'window-header';
                    
                    const windowTitle = document.createElement('div');
                    windowTitle.className = 'window-title';
                    windowTitle.textContent = title;
                    
                    const windowControls = document.createElement('div');
                    windowControls.className = 'window-controls';
                    
                    const minimizeButton = document.createElement('div');
                    minimizeButton.className = 'window-control window-minimize';
                    minimizeButton.textContent = '_';
                    minimizeButton.addEventListener('click', () => this.minimizeWindow(windowId));
                    
                    const maximizeButton = document.createElement('div');
                    maximizeButton.className = 'window-control window-maximize';
                    maximizeButton.textContent = '‚ñ°';
                    maximizeButton.addEventListener('click', () => this.maximizeWindow(windowId));
                    
                    const closeButton = document.createElement('div');
                    closeButton.className = 'window-control window-close';
                    closeButton.textContent = '√ó';
                    closeButton.addEventListener('click', () => this.closeWindow(windowId));
                    
                    windowControls.appendChild(minimizeButton);
                    windowControls.appendChild(maximizeButton);
                    windowControls.appendChild(closeButton);
                    
                    windowHeader.appendChild(windowTitle);
                    windowHeader.appendChild(windowControls);
                    
                    // Create window content
                    const windowContent = document.createElement('div');
                    windowContent.className = 'window-content';
                    windowContent.id = `window-content-${windowId}`;
                    
                    // Assemble window
                    windowElement.appendChild(windowHeader);
                    windowElement.appendChild(windowContent);
                    
                    // Add to desktop
                    document.getElementById('desktop').appendChild(windowElement);
                    
                    // Add taskbar button
                    this.addTaskbarButton(windowId, title, appId);
                    
                    // Store window reference
                    VintageOS.state.windows[windowId] = {
                        element: windowElement,
                        title: title,
                        appId: appId,
                        isMaximized: false,
                        isMinimized: false,
                        originalDimensions: {
                            width: width,
                            height: height,
                            left: windowElement.style.left,
                            top: windowElement.style.top
                        }
                    };
                    
                    // Activate the window
                    this.activateWindow(windowId);
                    
                    return windowId;
                },
                
                addTaskbarButton: function(windowId, title, appId) {
                    const taskbarButtons = document.getElementById('taskbarButtons');
                    
                    const button = document.createElement('div');
                    button.className = 'task-button';
                    button.dataset.windowId = windowId;
                    button.textContent = title;
                    
                    // Find app icon if available
                    let appIcon = '';
                    if (VintageOS.builtInApps[appId]) {
                        appIcon = VintageOS.builtInApps[appId].icon;
                    } else {
                        const app = VintageOS.config.installedApps.find(app => app.id === appId);
                        if (app && app.icon) {
                            appIcon = app.icon;
                        }
                    }
                    
                    if (appIcon) {
                        button.textContent = `${appIcon} ${title}`;
                    }
                    
                    button.addEventListener('click', () => {
                        const window = VintageOS.state.windows[windowId];
                        if (window.isMinimized) {
                            this.restoreWindow(windowId);
                        } else if (VintageOS.state.activeWindow === windowId) {
                            this.minimizeWindow(windowId);
                        } else {
                            this.activateWindow(windowId);
                        }
                    });
                    
                    taskbarButtons.appendChild(button);
                },
                
                activateWindow: function(windowId) {
                    // Deactivate current active window
                    if (VintageOS.state.activeWindow) {
                        const activeWindow = VintageOS.state.windows[VintageOS.state.activeWindow];
                        if (activeWindow && activeWindow.element) {
                            activeWindow.element.style.zIndex = 100 + parseInt(VintageOS.state.activeWindow);
                        }
                        
                        const activeButton = document.querySelector(`.task-button[data-window-id="${VintageOS.state.activeWindow}"]`);
                        if (activeButton) {
                            activeButton.classList.remove('active');
                        }
                    }
                    
                    // Activate new window
                    const window = VintageOS.state.windows[windowId];
                    if (window && window.element) {
                        window.element.style.zIndex = 1000;
                        
                        const button = document.querySelector(`.task-button[data-window-id="${windowId}"]`);
                        if (button) {
                            button.classList.add('active');
                        }
                        
                        VintageOS.state.activeWindow = windowId;
                    }
                },
                
                closeWindow: function(windowId) {
                    const window = VintageOS.state.windows[windowId];
                    if (window && window.element) {
                        // Remove from DOM
                        window.element.remove();
                        
                        // Remove taskbar button
                        const button = document.querySelector(`.task-button[data-window-id="${windowId}"]`);
                        if (button) {
                            button.remove();
                        }
                        
                        // Clean up app references
                        if (VintageOS.state.runningApps[window.appId]) {
                            delete VintageOS.state.runningApps[window.appId];
                        }
                        
                        // Remove from windows registry
                        delete VintageOS.state.windows[windowId];
                        
                        // Update active window
                        if (VintageOS.state.activeWindow === windowId) {
                            VintageOS.state.activeWindow = null;
                            
                            // Activate the top-most window if available
                            const windowIds = Object.keys(VintageOS.state.windows);
                            if (windowIds.length > 0) {
                                this.activateWindow(windowIds[windowIds.length - 1]);
                            }
                        }
                    }
                },
                
                minimizeWindow: function(windowId) {
                    const window = VintageOS.state.windows[windowId];
                    if (window && window.element) {
                        window.element.style.display = 'none';
                        window.isMinimized = true;
                        
                        // Update taskbar button
                        const button = document.querySelector(`.task-button[data-window-id="${windowId}"]`);
                        if (button) {
                            button.classList.remove('active');
                        }
                        
                        // Update active window
                        if (VintageOS.state.activeWindow === windowId) {
                            VintageOS.state.activeWindow = null;
                            
                            // Activate the top-most visible window if available
                            const visibleWindows = Object.entries(VintageOS.state.windows)
                                .filter(([id, win]) => !win.isMinimized);
                                
                            if (visibleWindows.length > 0) {
                                this.activateWindow(visibleWindows[visibleWindows.length - 1][0]);
                            }
                        }
                    }
                },
                
                restoreWindow: function(windowId) {
                    const window = VintageOS.state.windows[windowId];
                    if (window && window.element) {
                        window.element.style.display = 'flex';
                        window.isMinimized = false;
                        this.activateWindow(windowId);
                    }
                },
                
                maximizeWindow: function(windowId) {
                    const window = VintageOS.state.windows[windowId];
                    if (window && window.element) {
                        if (window.isMaximized) {
                            // Restore original dimensions
                            window.element.style.width = window.originalDimensions.width + 'px';
                            window.element.style.height = window.originalDimensions.height + 'px';
                            window.element.style.left = window.originalDimensions.left;
                            window.element.style.top = window.originalDimensions.top;
                            window.isMaximized = false;
                        } else {
                            // Save original dimensions
                            window.originalDimensions = {
                                width: window.element.offsetWidth,
                                height: window.element.offsetHeight,
                                left: window.element.style.left,
                                top: window.element.style.top
                            };
                            
                            // Maximize
                            const desktop = document.getElementById('desktop');
                            window.element.style.width = desktop.offsetWidth + 'px';
                            window.element.style.height = desktop.offsetHeight + 'px';
                            window.element.style.left = '0';
                            window.element.style.top = '0';
                            window.isMaximized = true;
                        }
                    }
                },
                
                startDragging: function(windowId, event) {
                    const window = VintageOS.state.windows[windowId];
                    if (!window || !window.element || window.isMaximized) return;
                    
                    const windowElement = window.element;
                    
                    // Get initial mouse position
                    const initialX = event.clientX;
                    const initialY = event.clientY;
                    
                    // Get initial window position
                    const initialLeft = parseInt(windowElement.style.left) || 0;
                    const initialTop = parseInt(windowElement.style.top) || 0;
                    
                    // Set up move and stop handlers
                    const moveHandler = (e) => {
                        const dx = e.clientX - initialX;
                        const dy = e.clientY - initialY;
                        
                        windowElement.style.left = initialLeft + dx + 'px';
                        windowElement.style.top = initialTop + dy + 'px';
                    };
                    
                    const stopHandler = () => {
                        document.removeEventListener('mousemove', moveHandler);
                        document.removeEventListener('mouseup', stopHandler);
                    };
                    
                    // Attach handlers
                    document.addEventListener('mousemove', moveHandler);
                    document.addEventListener('mouseup', stopHandler);
                }
            },
            
            // Desktop Manager
            desktop: {
                init: function() {
                    this.createDesktopIcons();
                },
                
                createDesktopIcons: function() {
                    const desktopIcons = document.getElementById('desktopIcons');
                    desktopIcons.innerHTML = '';
                    
                    // Add system apps from config
                    VintageOS.config.desktopIcons.forEach(appId => {
                        if (VintageOS.builtInApps[appId]) {
                            this.createDesktopIcon(VintageOS.builtInApps[appId]);
                        }
                    });
                    
                    // Add installed apps that have desktop icon
                    VintageOS.config.installedApps.forEach(app => {
                        if (app.desktopIcon) {
                            this.createDesktopIcon(app);
                        }
                    });
                    
                    // Add files from /Desktop folder
                    const desktopFiles = VintageOS.fs.listFiles('/Desktop');
                    if (desktopFiles) {
                        desktopFiles.forEach(file => {
                            this.createFileIcon(file);
                        });
                    }
                },
                
                createDesktopIcon: function(app) {
                    const desktopIcons = document.getElementById('desktopIcons');
                    
                    const iconElement = document.createElement('div');
                    iconElement.className = 'desktop-icon';
                    iconElement.dataset.appId = app.id;
                    
                    const iconImage = document.createElement('div');
                    iconImage.className = 'icon-image';
                    iconImage.textContent = app.icon || app.id.charAt(0).toUpperCase();
                    
                    const iconText = document.createElement('div');
                    iconText.className = 'icon-text';
                    iconText.textContent = app.name;
                    
                    iconElement.appendChild(iconImage);
                    iconElement.appendChild(iconText);
                    
                    // Add tooltip
                    iconElement.addEventListener('mouseenter', (e) => {
                        VintageOS.showTooltip(e, app.description || app.name);
                    });
                    
                    iconElement.addEventListener('mouseleave', () => {
                        VintageOS.hideTooltip();
                    });
                    
                    // Add click handler
                    iconElement.addEventListener('click', () => {
                        VintageOS.launchApp(app.id);
                    });
                    
                    desktopIcons.appendChild(iconElement);
                },
                
                createFileIcon: function(file) {
                    const desktopIcons = document.getElementById('desktopIcons');
                    
                    const iconElement = document.createElement('div');
                    iconElement.className = 'desktop-icon';
                    iconElement.dataset.filePath = file.path;
                    
                    const iconImage = document.createElement('div');
                    iconImage.className = 'icon-image';
                    
                    if (file.type === 'folder') {
                        iconImage.textContent = 'üìÅ';
                    } else {
                        // Determine icon based on file extension
                        const ext = file.name.split('.').pop().toLowerCase();
                        if (ext === 'json') {
                            iconImage.textContent = '{}';
                        } else if (ext === 'txt') {
                            iconImage.textContent = 'TXT';
                        } else if (ext === 'js') {
                            iconImage.textContent = 'JS';
                        } else {
                            iconImage.textContent = 'üìÑ';
                        }
                    }
                    
                    const iconText = document.createElement('div');
                    iconText.className = 'icon-text';
                    iconText.textContent = file.name;
                    
                    iconElement.appendChild(iconImage);
                    iconElement.appendChild(iconText);
                    
                    // Add tooltip
                    iconElement.addEventListener('mouseenter', (e) => {
                        VintageOS.showTooltip(e, file.path);
                    });
                    
                    iconElement.addEventListener('mouseleave', () => {
                        VintageOS.hideTooltip();
                    });
                    
                    // Add click handler
                    iconElement.addEventListener('click', () => {
                        if (file.type === 'folder') {
                            VintageOS.launchApp('fileManager', file.path);
                        } else {
                            VintageOS.openFile(file.path);
                        }
                    });
                    
                    desktopIcons.appendChild(iconElement);
                },
                
                refresh: function() {
                    this.createDesktopIcons();
                }
            },
            
            // File System
            fs: {
                init: function() {
                    // Initialize root structure if not exists
                    if (!localStorage.getItem('vos_filesystem')) {
                        const initialFs = {
                            '/': {
                                type: 'folder',
                                children: ['Desktop', 'Documents', 'Applications', 'System']
                            },
                            '/Desktop': {
                                type: 'folder',
                                children: []
                            },
                            '/Documents': {
                                type: 'folder',
                                children: []
                            },
                            '/Applications': {
                                type: 'folder',
                                children: []
                            },
                            '/System': {
                                type: 'folder',
                                children: ['Config']
                            },
                            '/System/Config': {
                                type: 'folder',
                                children: []
                            }
                        };
                        
                        localStorage.setItem('vos_filesystem', JSON.stringify(initialFs));
                    }
                },
                
                // Get filesystem object
                getFs: function() {
                    try {
                        return JSON.parse(localStorage.getItem('vos_filesystem') || '{}');
                    } catch (e) {
                        console.error('Error parsing filesystem:', e);
                        return {};
                    }
                },
                
                // Save filesystem object
                saveFs: function(fs) {
                    localStorage.setItem('vos_filesystem', JSON.stringify(fs));
                },
                
                // Normalize path
                normalizePath: function(path) {
                    // Ensure path starts with /
                    if (!path.startsWith('/')) {
                        path = '/' + path;
                    }
                    
                    // Remove trailing slash unless root
                    if (path.length > 1 && path.endsWith('/')) {
                        path = path.slice(0, -1);
                    }
                    
                    return path;
                },
                
                // Create folder
                createFolder: function(parentPath, folderName) {
                    parentPath = this.normalizePath(parentPath);
                    
                    // Check for invalid characters
                    if (folderName.includes('/') || folderName.includes('\\')) {
                        throw new Error('Folder name cannot contain slashes');
                    }
                    
                    const fs = this.getFs();
                    
                    // Check if parent exists
                    if (!fs[parentPath]) {
                        throw new Error(`Parent folder not found: ${parentPath}`);
                    }
                    
                    // Check if parent is a folder
                    if (fs[parentPath].type !== 'folder') {
                        throw new Error(`Parent is not a folder: ${parentPath}`);
                    }
                    
                    const newPath = `${parentPath}/${folderName}`;
                    
                    // Check if folder already exists
                    if (fs[newPath]) {
                        throw new Error(`Folder already exists: ${newPath}`);
                    }
                    
                    // Create folder
                    fs[newPath] = {
                        type: 'folder',
                        children: []
                    };
                    
                    // Add to parent
                    fs[parentPath].children.push(folderName);
                    
                    // Save filesystem
                    this.saveFs(fs);
                    
                    return newPath;
                },
                
                // List files in a folder
                listFiles: function(path) {
                    path = this.normalizePath(path);
                    const fs = this.getFs();
                    
                    // Check if folder exists
                    if (!fs[path]) {
                        return null;
                    }
                    
                    // Check if it's a folder
                    if (fs[path].type !== 'folder') {
                        return null;
                    }
                    
                    // Get children
                    return fs[path].children.map(childName => {
                        const childPath = `${path}/${childName}`;
                        const child = fs[childPath];
                        
                        return {
                            name: childName,
                            path: childPath,
                            type: child ? child.type : 'unknown'
                        };
                    });
                },
                
                // Write file
                writeFile: function(path, content) {
                    path = this.normalizePath(path);
                    
                    // Extract parent path and filename
                    const lastSlash = path.lastIndexOf('/');
                    const parentPath = path.substring(0, lastSlash);
                    const fileName = path.substring(lastSlash + 1);
                    
                    const fs = this.getFs();
                    
                    // Check if parent exists
                    if (!fs[parentPath]) {
                        throw new Error(`Parent folder not found: ${parentPath}`);
                    }
                    
                    // Check if parent is a folder
                    if (fs[parentPath].type !== 'folder') {
                        throw new Error(`Parent is not a folder: ${parentPath}`);
                    }
                    
                    // Add to parent if it's a new file
                    if (!fs[path] && !fs[parentPath].children.includes(fileName)) {
                        fs[parentPath].children.push(fileName);
                    }
                    
                    // Write file
                    fs[path] = {
                        type: 'file',
                        content: content
                    };
                    
                    // Save filesystem
                    this.saveFs(fs);
                    
                    return true;
                },
                
                // Read file
                readFile: function(path) {
                    path = this.normalizePath(path);
                    const fs = this.getFs();
                    
                    // Check if file exists
                    if (!fs[path]) {
                        return null;
                    }
                    
                    // Check if it's a file
                    if (fs[path].type !== 'file') {
                        return null;
                    }
                    
                    return fs[path].content;
                },
                
                // Delete file or folder
                deleteFile: function(path) {
                    path = this.normalizePath(path);
                    
                    // Can't delete root
                    if (path === '/') {
                        throw new Error('Cannot delete root folder');
                    }
                    
                    // Extract parent path and filename
                    const lastSlash = path.lastIndexOf('/');
                    const parentPath = path.substring(0, lastSlash) || '/';
                    const fileName = path.substring(lastSlash + 1);
                    
                    const fs = this.getFs();
                    
                    // Check if file exists
                    if (!fs[path]) {
                        throw new Error(`File not found: ${path}`);
                    }
                    
                    // If it's a folder, make sure it's empty
                    if (fs[path].type === 'folder' && fs[path].children.length > 0) {
                        throw new Error(`Folder is not empty: ${path}`);
                    }
                    
                    // Remove from parent
                    const parentIndex = fs[parentPath].children.indexOf(fileName);
                    if (parentIndex !== -1) {
                        fs[parentPath].children.splice(parentIndex, 1);
                    }
                    
                    // Delete file
                    delete fs[path];
                    
                    // If it's a folder, delete all children recursively
                    if (fs[path] && fs[path].type === 'folder') {
                        Object.keys(fs).forEach(key => {
                            if (key.startsWith(path + '/')) {
                                delete fs[key];
                            }
                        });
                    }
                    
                    // Save filesystem
                    this.saveFs(fs);
                    
                    return true;
                },
                
                // Check if file exists
                fileExists: function(path) {
                    path = this.normalizePath(path);
                    const fs = this.getFs();
                    return !!fs[path];
                },
                
                // Get file info
                getFileInfo: function(path) {
                    path = this.normalizePath(path);
                    const fs = this.getFs();
                    
                    if (!fs[path]) {
                        return null;
                    }
                    
                    const lastSlash = path.lastIndexOf('/');
                    const fileName = path.substring(lastSlash + 1);
                    
                    return {
                        name: fileName,
                        path: path,
                        type: fs[path].type
                    };
                }
            },
            
            // App Store / App Management
            appStore: {
                openAppLauncher: function() {
                    // Create a window for the app launcher
                    const windowId = VintageOS.windowManager.createWindow('App Launcher', 'appStore', 600, 450);
                    const windowContent = document.getElementById(`window-content-${windowId}`);
                    
                    // Build the app launcher UI
                    let html = `
                        <div style="padding: 10px;">
                            <h2>Installed Applications</h2>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
                    `;
                    
                    // Add built-in apps
                    Object.values(VintageOS.builtInApps).forEach(app => {
                        html += `
                            <div class="app-item" style="width: 100px; text-align: center; cursor: pointer;" 
                                 data-app-id="${app.id}" title="${app.description || ''}">
                                <div class="icon-image" style="margin: 0 auto 5px;">${app.icon || app.id.charAt(0).toUpperCase()}</div>
                                <div>${app.name}</div>
                            </div>
                        `;
                    });
                    
                    // Add installed apps
                    VintageOS.config.installedApps.forEach(app => {
                        html += `
                            <div class="app-item" style="width: 100px; text-align: center; cursor: pointer;" 
                                 data-app-id="${app.id}" title="${app.description || ''}">
                                <div class="icon-image" style="margin: 0 auto 5px;">${app.icon || app.id.charAt(0).toUpperCase()}</div>
                                <div>${app.name}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                            <h3 style="margin-top: 20px;">Actions</h3>
                            <div style="margin-top: 10px;">
                                <button id="installNewApp">Install New App</button>
                                <button id="manageApps">Manage Apps</button>
                            </div>
                        </div>
                    `;
                    
                    windowContent.innerHTML = html;
                    
                    // Add event listeners
                    windowContent.querySelectorAll('.app-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const appId = item.dataset.appId;
                            VintageOS.launchApp(appId);
                        });
                    });
                    
                    windowContent.querySelector('#installNewApp').addEventListener('click', () => {
                        document.getElementById('installAppModal').style.display = 'flex';
                    });
                    
                    windowContent.querySelector('#manageApps').addEventListener('click', () => {
                        this.openAppManager();
                        VintageOS.windowManager.closeWindow(windowId);
                    });
                    
                    return windowId;
                },
                
                openAppManager: function() {
                    // Create a window for the app manager
                    const windowId = VintageOS.windowManager.createWindow('App Manager', 'appStore', 700, 500);
                    const windowContent = document.getElementById(`window-content-${windowId}`);
                    
                    // Build the app manager UI
                    let html = `
                        <div style="padding: 10px;">
                            <h2>Manage Applications</h2>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                <thead>
                                    <tr>
                                        <th style="text-align: left; padding: 5px; border-bottom: 1px solid var(--main-border);">Name</th>
                                        <th style="text-align: left; padding: 5px; border-bottom: 1px solid var(--main-border);">Version</th>
                                        <th style="text-align: left; padding: 5px; border-bottom: 1px solid var(--main-border);">Author</th>
                                        <th style="text-align: left; padding: 5px; border-bottom: 1px solid var(--main-border);">Type</th>
                                        <th style="text-align: left; padding: 5px; border-bottom: 1px solid var(--main-border);">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Add built-in apps
                    Object.values(VintageOS.builtInApps).forEach(app => {
                        html += `
                            <tr>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">${app.name}</td>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">${app.version}</td>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">${app.author}</td>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">System</td>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">
                                    <button data-app-id="${app.id}" class="launch-app-btn">Launch</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    // Add installed apps
                    VintageOS.config.installedApps.forEach(app => {
                        html += `
                            <tr>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">${app.name}</td>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">${app.version}</td>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">${app.author}</td>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">Custom</td>
                                <td style="padding: 5px; border-bottom: 1px solid rgba(0, 170, 0, 0.2);">
                                    <button data-app-id="${app.id}" class="launch-app-btn">Launch</button>
                                    <button data-app-id="${app.id}" class="export-app-btn">Export</button>
                                    <button data-app-id="${app.id}" class="remove-app-btn">Remove</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                            <div style="margin-top: 20px;">
                                <button id="installNewAppBtn">Install New App</button>
                                <button id="refreshAppsBtn">Refresh</button>
                            </div>
                        </div>
                    `;
                    
                    windowContent.innerHTML = html;
                    
                    // Add event listeners
                    windowContent.querySelectorAll('.launch-app-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const appId = btn.dataset.appId;
                            VintageOS.launchApp(appId);
                        });
                    });
                    
                    windowContent.querySelectorAll('.export-app-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const appId = btn.dataset.appId;
                            this.exportApp(appId);
                        });
                    });
                    
                    windowContent.querySelectorAll('.remove-app-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const appId = btn.dataset.appId;
                            if (confirm(`Are you sure you want to remove ${appId}?`)) {
                                this.removeApp(appId);
                                this.openAppManager(); // Refresh the view
                                VintageOS.windowManager.closeWindow(windowId);
                            }
                        });
                    });
                    
                    windowContent.querySelector('#installNewAppBtn').addEventListener('click', () => {
                        document.getElementById('installAppModal').style.display = 'flex';
                    });
                    
                    windowContent.querySelector('#refreshAppsBtn').addEventListener('click', () => {
                        this.openAppManager();
                        VintageOS.windowManager.closeWindow(windowId);
                    });
                    
                    return windowId;
                },
                
                exportApp: function(appId) {
                    const app = VintageOS.config.installedApps.find(app => app.id === appId);
                    if (!app) {
                        VintageOS.showNotification('App not found');
                        return;
                    }
                    
                    // Create a downloadable JSON file
                    const appJson = JSON.stringify(app, null, 2);
                    const blob = new Blob([appJson], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${appId}.json`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    
                    VintageOS.showNotification(`App ${appId} exported successfully`);
                },
                
                removeApp: function(appId) {
                    // Check if app is in reserved list
                    if (VintageOS.config.systemReservedApps.includes(appId)) {
                        VintageOS.showNotification('Cannot remove system app');
                        return;
                    }
                    
                    // Check if app is running
                    if (VintageOS.state.runningApps[appId]) {
                        const windowId = VintageOS.state.runningApps[appId].windowId;
                        VintageOS.windowManager.closeWindow(windowId);
                    }
                    
                    // Remove app from installed apps
                    VintageOS.config.installedApps = VintageOS.config.installedApps.filter(app => app.id !== appId);
                    
                    // Remove from desktop icons if present
                    VintageOS.config.desktopIcons = VintageOS.config.desktopIcons.filter(id => id !== appId);
                    
                    // Save configuration
                    VintageOS.saveSystemConfig();
                    
                    // Refresh desktop
                    VintageOS.desktop.refresh();
                    
                    VintageOS.showNotification(`App ${appId} removed successfully`);
                }
            },
            
            // Install app from modal
            installAppFromModal: function() {
                try {
                    let appJson;
                    const fileInput = document.getElementById('appJsonFile');
                    const textInput = document.getElementById('appJsonInput');
                    
                    if (fileInput.files.length > 0) {
                        // Read from file
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                appJson = JSON.parse(e.target.result);
                                this.processAppInstallation(appJson);
                            } catch (error) {
                                VintageOS.showNotification('Invalid JSON file');
                                console.error('Error parsing JSON:', error);
                            }
                        };
                        reader.readAsText(fileInput.files[0]);
                    } else if (textInput.value.trim()) {
                        // Read from text input
                        try {
                            appJson = JSON.parse(textInput.value);
                            this.processAppInstallation(appJson);
                        } catch (error) {
                            VintageOS.showNotification('Invalid JSON content');
                            console.error('Error parsing JSON:', error);
                        }
                    } else {
                        VintageOS.showNotification('No app JSON provided');
                    }
                } catch (error) {
                    VintageOS.showNotification('Error installing app');
                    console.error('Error installing app:', error);
                }
            },
            
            // Process app installation
            processAppInstallation: function(appJson) {
                // Validate app structure
                if (!appJson.id || !appJson.name || !appJson.version || !appJson.code) {
                    VintageOS.showNotification('Invalid app structure');
                    return;
                }
                
                // Check if app already exists
                const existingAppIndex = this.config.installedApps.findIndex(app => app.id === appJson.id);
                
                if (existingAppIndex !== -1) {
                    // Update existing app
                    this.config.installedApps[existingAppIndex] = appJson;
                    VintageOS.showNotification(`App ${appJson.name} updated to version ${appJson.version}`);
                } else {
                    // Add new app
                    this.config.installedApps.push(appJson);
                    VintageOS.showNotification(`App ${appJson.name} installed successfully`);
                    
                    // Add to desktop if specified
                    if (appJson.desktopIcon) {
                        if (!this.config.desktopIcons.includes(appJson.id)) {
                            this.config.desktopIcons.push(appJson.id);
                        }
                    }
                }
                
                // Save configuration
                this.saveSystemConfig();
                
                // Refresh desktop
                this.desktop.refresh();
                
                // Clear modal
                document.getElementById('appJsonFile').value = '';
                document.getElementById('appJsonInput').value = '';
                document.getElementById('installAppModal').style.display = 'none';
            },
            
            // Open system settings
            openSystemSettings: function() {
                // Populate form with current settings
                document.getElementById('settingTheme').value = this.config.theme;
                document.getElementById('settingFontSize').value = this.config.fontSize;
                document.getElementById('fontSizeValue').textContent = `${this.config.fontSize}px`;
                document.getElementById('settingAutoSave').value = this.config.autoSaveInterval;
                
                // Show modal
                document.getElementById('systemSettingsModal').style.display = 'flex';
            },
            
            // Save system settings
            saveSystemSettings: function() {
                // Get values from form
                this.config.theme = document.getElementById('settingTheme').value;
                this.config.fontSize = parseInt(document.getElementById('settingFontSize').value);
                this.config.autoSaveInterval = parseInt(document.getElementById('settingAutoSave').value);
                
                // Apply theme
                this.applyTheme(this.config.theme);
                
                // Apply font size
                document.documentElement.style.setProperty('--base-font-size', `${this.config.fontSize}px`);
                
                // Save configuration
                this.saveSystemConfig();
                
                // Hide modal
                document.getElementById('systemSettingsModal').style.display = 'none';
                
                // Update auto-save interval
                if (this._autoSaveInterval) {
                    clearInterval(this._autoSaveInterval);
                }
                
                if (this.config.autoSaveInterval > 0) {
                    this._autoSaveInterval = setInterval(() => this.saveSystemState(), this.config.autoSaveInterval * 1000);
                }
                
                this.showNotification('Settings saved');
            },
            
            // Export system configuration
            exportSystemConfig: function() {
                const config = {
                    system: {
                        version: this.version,
                        name: this.name,
                        config: this.config
                    },
                    apps: this.config.installedApps
                };
                
                const configJson = JSON.stringify(config, null, 2);
                const blob = new Blob([configJson], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'vintage_os_config.json';
                a.click();
                
                URL.revokeObjectURL(url);
                
                this.showNotification('Configuration exported successfully');
            },
            
            // Import system configuration
            importSystemConfig: function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const config = JSON.parse(e.target.result);
                        
                        if (!config.system || !config.apps) {
                            throw new Error('Invalid configuration file');
                        }
                        
                        // Update system config
                        this.config = {...this.config, ...config.system.config};
                        
                        // Ensure system reserved apps
                        this.config.systemReservedApps = [
                            'mathematicalSandbox', 'fileManager', 'appStore', 'terminal', 'settings'
                        ];
                        
                        // Update installed apps
                        this.config.installedApps = config.apps;
                        
                        // Save configuration
                        this.saveSystemConfig();
                        
                        // Apply theme
                        this.applyTheme(this.config.theme);
                        
                        // Refresh desktop
                        this.desktop.refresh();
                        
                        this.showNotification('Configuration imported successfully');
                        
                        // Reload settings view
                        this.openSystemSettings();
                    } catch (error) {
                        this.showNotification('Error importing configuration');
                        console.error('Error importing configuration:', error);
                    }
                };
                
                reader.readAsText(file);
            },
            
            // Reset system
            resetSystem: function() {
                // Clear all localStorage except filesystem
                const fsData = localStorage.getItem('vos_filesystem');
                
                localStorage.clear();
                
                if (fsData) {
                    localStorage.setItem('vos_filesystem', fsData);
                }
                
                // Reset config to defaults
                this.config = {
                    theme: 'default',
                    fontSize: 12,
                    autoSaveInterval: 60,
                    installedApps: [],
                    desktopIcons: ['mathematicalSandbox', 'fileManager', 'appStore', 'terminal', 'settings'],
                    systemReservedApps: ['mathematicalSandbox', 'fileManager', 'appStore', 'terminal', 'settings']
                };
                
                // Save configuration
                this.saveSystemConfig();
                
                // Close all windows
                Object.keys(this.state.windows).forEach(windowId => {
                    this.windowManager.closeWindow(windowId);
                });
                
                // Refresh desktop
                this.desktop.refresh();
                
                // Apply default theme
                this.applyTheme('default');
                
                this.showNotification('System reset to default settings');
                
                // Reload page
                location.reload();
            },
            
            // Apply theme
            applyTheme: function(theme) {
                const root = document.documentElement;
                
                switch (theme) {
                    case 'blue':
                        root.style.setProperty('--main-text', '#33aaff');
                        root.style.setProperty('--main-border', '#33aaff');
                        root.style.setProperty('--highlight', '#0077cc');
                        root.style.setProperty('--window-header', '#003366');
                        root.style.setProperty('--scrollbar-thumb', '#0077cc');
                        root.style.setProperty('--tooltip-border', '#0077cc');
                        break;
                        
                    case 'amber':
                        root.style.setProperty('--main-text', '#ffaa00');
                        root.style.setProperty('--main-border', '#ffaa00');
                        root.style.setProperty('--highlight', '#cc7700');
                        root.style.setProperty('--window-header', '#664400');
                        root.style.setProperty('--scrollbar-thumb', '#cc7700');
                        root.style.setProperty('--tooltip-border', '#cc7700');
                        break;
                        
                    case 'pink':
                        root.style.setProperty('--main-text', '#ff33aa');
                        root.style.setProperty('--main-border', '#ff33aa');
                        root.style.setProperty('--highlight', '#cc0077');
                        root.style.setProperty('--window-header', '#550033');
                        root.style.setProperty('--scrollbar-thumb', '#cc0077');
                        root.style.setProperty('--tooltip-border', '#cc0077');
                        break;
                        
                    default: // Green (default)
                        root.style.setProperty('--main-text', '#33ff33');
                        root.style.setProperty('--main-border', '#33ff33');
                        root.style.setProperty('--highlight', '#00aa00');
                        root.style.setProperty('--window-header', '#005500');
                        root.style.setProperty('--scrollbar-thumb', '#00aa00');
                        root.style.setProperty('--tooltip-border', '#00aa00');
                        break;
                }
            },
            
            // Show system info
            showSystemInfo: function() {
                const windowId = this.windowManager.createWindow('System Information', 'systemInfo', 500, 300);
                const windowContent = document.getElementById(`window-content-${windowId}`);
                
                const uptime = this.formatUptime(Date.now() - this.state.systemStartTime);
                const installedApps = this.config.installedApps.length;
                const builtInApps = Object.keys(this.builtInApps).length;
                const totalApps = installedApps + builtInApps;
                const runningApps = Object.keys(this.state.runningApps).length;
                const windows = Object.keys(this.state.windows).length;
                
                windowContent.innerHTML = `
                    <div style="padding: 15px;">
                        <h2>System Information</h2>
                        <table style="width: 100%; margin-top: 15px;">
                            <tr>
                                <td>System Name:</td>
                                <td>${this.name}</td>
                            </tr>
                            <tr>
                                <td>Version:</td>
                                <td>${this.version}</td>
                            </tr>
                            <tr>
                                <td>Uptime:</td>
                                <td>${uptime}</td>
                            </tr>
                            <tr>
                                <td>Theme:</td>
                                <td>${this.config.theme}</td>
                            </tr>
                            <tr>
                                <td>Apps Installed:</td>
                                <td>${totalApps} (${builtInApps} built-in, ${installedApps} custom)</td>
                            </tr>
                            <tr>
                                <td>Running Apps:</td>
                                <td>${runningApps}</td>
                            </tr>
                            <tr>
                                <td>Open Windows:</td>
                                <td>${windows}</td>
                            </tr>
                            <tr>
                                <td>Storage Usage:</td>
                                <td>${this.formatStorageUsage()}</td>
                            </tr>
                        </table>
                        <div style="margin-top: 20px; text-align: center;">
                            <button id="refreshInfoBtn">Refresh</button>
                        </div>
                    </div>
                `;
                
                windowContent.querySelector('#refreshInfoBtn').addEventListener('click', () => {
                    this.showSystemInfo();
                    this.windowManager.closeWindow(windowId);
                });
            },
            
            // Format uptime
            formatUptime: function(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                return `${days}d ${hours % 24}h ${minutes % 60}m ${seconds % 60}s`;
            },
            
            // Format storage usage
            formatStorageUsage: function() {
                const totalStorage = 5 * 1024 * 1024; // 5MB limit for localStorage
                let usedStorage = 0;
                
                // Estimate storage usage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    usedStorage += (key.length + value.length) * 2; // UTF-16 encoding
                }
                
                const usedKB = (usedStorage / 1024).toFixed(2);
                const totalKB = (totalStorage / 1024).toFixed(2);
                const percentage = ((usedStorage / totalStorage) * 100).toFixed(1);
                
                return `${usedKB} KB / ${totalKB} KB (${percentage}%)`;
            },
            
            // Load system configuration
            loadSystemConfig: function() {
                try {
                    const savedConfig = localStorage.getItem('vos_config');
                    if (savedConfig) {
                        const parsedConfig = JSON.parse(savedConfig);
                        this.config = {...this.config, ...parsedConfig};
                    }
                } catch (e) {
                    console.error('Error loading system configuration:', e);
                }
            },
            
            // Save system configuration
            saveSystemConfig: function() {
                try {
                    localStorage.setItem('vos_config', JSON.stringify(this.config));
                } catch (e) {
                    console.error('Error saving system configuration:', e);
                    this.showNotification('Error saving configuration');
                }
            },
            
            // Save system state
            saveSystemState: function() {
                this.saveSystemConfig();
                this.state.lastSaveTime = Date.now();
                console.log('System state saved');
            },
            
            // Show notification
            showNotification: function(message) {
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.bottom = '40px';
                notification.style.right = '10px';
                notification.style.backgroundColor = 'var(--terminal-bg)';
                notification.style.color = 'var(--main-text)';
                notification.style.padding = '10px 15px';
                notification.style.borderRadius = '3px';
                notification.style.border = '1px solid var(--main-border)';
                notification.style.boxShadow = '0 0 10px rgba(0, 255, 0, 0.3)';
                notification.style.zIndex = '2000';
                notification.style.maxWidth = '250px';
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 500);
                }, 3000);
            },
            
            // Show tooltip
            showTooltip: function(event, text) {
                const tooltip = document.getElementById('tooltip');
                tooltip.textContent = text;
                tooltip.style.left = `${event.pageX + 10}px`;
                tooltip.style.top = `${event.pageY + 10}px`;
                tooltip.style.display = 'block';
            },
            
            // Hide tooltip
            hideTooltip: function() {
                document.getElementById('tooltip').style.display = 'none';
            },
            
            // Open a file
            openFile: function(path) {
                const content = this.fs.readFile(path);
                if (content === null) {
                    this.showNotification(`File not found: ${path}`);
                    return;
                }
                
                // Extract file extension
                const ext = path.split('.').pop().toLowerCase();
                
                // Handle based on file type
                if (ext === 'json') {
                    // Check if it's an app
                    try {
                        const json = JSON.parse(content);
                        if (json.id && json.name && json.version && json.code) {
                            // It's probably an app
                            if (confirm(`This appears to be an app. Do you want to install "${json.name}" v${json.version}?`)) {
                                this.processAppInstallation(json);
                                return;
                            }
                        }
                    } catch (e) {
                        // Not valid JSON or not an app
                    }
                    
                    // Open as text
                    this.openTextEditor(path, content);
                } else if (ext === 'js' || ext === 'txt' || ext === 'md' || ext === 'css' || ext === 'html') {
                    // Text files
                    this.openTextEditor(path, content);
                } else {
                    // Unknown file type
                    this.showNotification(`Unknown file type: ${ext}`);
                }
            },
            
            // Open text editor
            openTextEditor: function(path, content) {
                const fileName = path.split('/').pop();
                const windowId = this.windowManager.createWindow(`Editor - ${fileName}`, 'textEditor', 600, 400);
                const windowContent = document.getElementById(`window-content-${windowId}`);
                
                windowContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; height: 100%;">
                        <div style="padding: 5px; border-bottom: 1px solid var(--main-border);">
                            <button id="saveBtn">Save</button>
                            <button id="saveAsBtn">Save As</button>
                            <span style="margin-left: 10px;">${path}</span>
                        </div>
                        <textarea id="editor" style="flex: 1; padding: 10px; background-color: var(--terminal-bg); color: var(--main-text); border: none; resize: none; font-family: monospace;">${content}</textarea>
                    </div>
                `;
                
                const editor = windowContent.querySelector('#editor');
                
                windowContent.querySelector('#saveBtn').addEventListener('click', () => {
                    try {
                        this.fs.writeFile(path, editor.value);
                        this.showNotification(`File saved: ${path}`);
                    } catch (e) {
                        this.showNotification(`Error saving file: ${e.message}`);
                    }
                });
                
                windowContent.querySelector('#saveAsBtn').addEventListener('click', () => {
                    const newPath = prompt('Enter new file path:', path);
                    if (newPath) {
                        try {
                            this.fs.writeFile(newPath, editor.value);
                            this.showNotification(`File saved as: ${newPath}`);
                            
                            // Update window title
                            const fileName = newPath.split('/').pop();
                            document.querySelector(`.window[data-window-id="${windowId}"] .window-title`).textContent = `Editor - ${fileName}`;
                            
                            // Update path display
                            windowContent.querySelector('span').textContent = newPath;
                        } catch (e) {
                            this.showNotification(`Error saving file: ${e.message}`);
                        }
                    }
                });
            },
            
            // Built-in apps implementations
            apps: {
                // Mathematical Sandbox
                mathematicalSandbox: {
                    init: function() {
                        const windowId = VintageOS.windowManager.createWindow('Mathematical Sandbox', 'mathematicalSandbox', 800, 600);
                        const windowContent = document.getElementById(`window-content-${windowId}`);
                        
                        // Set up the app content
                        let html = `
                            <div style="display: flex; flex-direction: column; height: 100%;">
                                <div style="padding: 5px; border-bottom: 1px solid var(--main-border);">
                                    <button id="newGridBtn">New Grid</button>
                                    <button id="saveGridBtn">Save</button>
                                    <button id="loadGridBtn">Load</button>
                                    <button id="undoBtn">Undo</button>
                                    <button id="redoBtn">Redo</button>
                                    <button id="mathMenuBtn">Math</button>
                                    <button id="helpBtn">Help</button>
                                </div>
                                
                                <div id="setupPanel" style="padding: 20px;">
                                    <h3>Grid Configuration</h3>
                                    <div style="margin-bottom: 10px;">
                                        <label>Cell Size (pixels): </label>
                                        <input type="number" id="cellSize" min="50" value="70">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label>Grid Rows: </label>
                                        <input type="number" id="gridRows" min="1" value="4">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <label>Grid Columns: </label>
                                        <input type="number" id="gridCols" min="1" value="4">
                                    </div>
                                    <button id="createGridBtn">Create Grid</button>
                                </div>
                                
                                <div id="gridContainer" class="grid-container" style="display: none;">
                                    <div id="grid" class="grid"></div>
                                </div>
                                
                                <div id="statusBar" style="padding: 5px; border-top: 1px solid var(--main-border); font-size: 12px;">
                                    Ready.
                                </div>
                            </div>
                            
                            <!-- Cell Properties Modal -->
                            <div id="cellModal" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--terminal-bg); border: 1px solid var(--main-border); padding: 15px; z-index: 100; width: 300px;">
                                <h3>Cell Properties</h3>
                                <div style="margin-bottom: 10px;">
                                    <label>Text: </label>
                                    <input type="text" id="cellText">
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label>Expression: </label>
                                    <input type="text" id="cellExpression">
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label>Background Color: </label>
                                    <input type="color" id="cellBgColor" value="#222222">
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label>Font Size: </label>
                                    <input type="range" id="cellFontSize" min="6" max="72" value="12">
                                    <span id="fontSizeValue">12</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label>Font Color: </label>
                                    <input type="color" id="cellFontColor" value="#33ff33">
                                </div>
                                <div style="text-align: right;">
                                    <button id="applyCellBtn">Apply</button>
                                    <button id="cancelCellBtn">Cancel</button>
                                </div>
                            </div>
                            
                            <!-- Math Menu Modal -->
                            <div id="mathMenuModal" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--terminal-bg); border: 1px solid var(--main-border); padding: 15px; z-index: 100; width: 300px;">
                                <h3>Mathematical Tools</h3>
                                <div style="margin-top: 10px;">
                                    <button id="matrixBtn" style="width: 100%; margin-bottom: 5px;">Matrix Operations</button>
                                    <button id="plotFunctionBtn" style="width: 100%; margin-bottom: 5px;">Plot Function</button>
                                    <button id="vectorFieldBtn" style="width: 100%; margin-bottom: 5px;">Vector Field</button>
                                    <button id="complexBtn" style="width: 100%; margin-bottom: 5px;">Complex Visualization</button>
                                    <button id="fractalBtn" style="width: 100%; margin-bottom: 5px;">Fractals</button>
                                </div>
                                <div style="text-align: right; margin-top: 10px;">
                                    <button id="closeMathMenuBtn">Close</button>
                                </div>
                            </div>
                        `;
                        
                        windowContent.innerHTML = html;
                        
                        // Add additional modals and functionality here
                        
                        // App state
                        const appState = {
                            squareData: {},       // Cell data
                            splitSquares: {},     // Split cells info
                            actionHistory: [],    // For undo
                            redoStack: [],        // For redo
                            squareSize: 70,       // Default cell size
                            numRows: 4,           // Default rows
                            numCols: 4,           // Default columns
                            currentCell: null     // Currently selected cell
                        };
                        
                        // Initialize event handlers
                        windowContent.querySelector('#createGridBtn').addEventListener('click', () => {
                            createGrid();
                        });
                        
                        windowContent.querySelector('#newGridBtn').addEventListener('click', () => {
                            if (confirm('Create a new grid? All unsaved changes will be lost.')) {
                                windowContent.querySelector('#setupPanel').style.display = 'block';
                                windowContent.querySelector('#gridContainer').style.display = 'none';
                                appState.squareData = {};
                                appState.splitSquares = {};
                                appState.actionHistory = [];
                                appState.redoStack = [];
                            }
                        });
                        
                        windowContent.querySelector('#saveGridBtn').addEventListener('click', () => {
                            saveGrid();
                        });
                        
                        windowContent.querySelector('#loadGridBtn').addEventListener('click', () => {
                            loadGrid();
                        });
                        
                        windowContent.querySelector('#undoBtn').addEventListener('click', () => {
                            undo();
                        });
                        
                        windowContent.querySelector('#redoBtn').addEventListener('click', () => {
                            redo();
                        });
                        
                        windowContent.querySelector('#mathMenuBtn').addEventListener('click', () => {
                            windowContent.querySelector('#mathMenuModal').style.display = 'block';
                        });
                        
                        windowContent.querySelector('#closeMathMenuBtn').addEventListener('click', () => {
                            windowContent.querySelector('#mathMenuModal').style.display = 'none';
                        });
                        
                        windowContent.querySelector('#helpBtn').addEventListener('click', () => {
                            alert('Mathematical Sandbox Help\n\n' + 
                                  'Left Click: Edit cell\n' + 
                                  'Right Click: Split/merge cell\n' + 
                                  'Expressions: Use standard JavaScript math expressions (e.g., sin(x), 2+3)\n' + 
                                  'Math Menu: Access additional mathematical tools');
                        });
                        
                        windowContent.querySelector('#cancelCellBtn').addEventListener('click', () => {
                            windowContent.querySelector('#cellModal').style.display = 'none';
                        });
                        
                        windowContent.querySelector('#applyCellBtn').addEventListener('click', () => {
                            applyCellProperties();
                        });
                        
                        windowContent.querySelector('#cellFontSize').addEventListener('input', function() {
                            windowContent.querySelector('#fontSizeValue').textContent = this.value;
                        });
                        
                        // Math menu buttons
                        windowContent.querySelector('#matrixBtn').addEventListener('click', () => {
                            openMatrixTool();
                            windowContent.querySelector('#mathMenuModal').style.display = 'none';
                        });
                        
                        windowContent.querySelector('#plotFunctionBtn').addEventListener('click', () => {
                            openPlotTool();
                            windowContent.querySelector('#mathMenuModal').style.display = 'none';
                        });
                        
                        windowContent.querySelector('#vectorFieldBtn').addEventListener('click', () => {
                            openVectorFieldTool();
                            windowContent.querySelector('#mathMenuModal').style.display = 'none';
                        });
                        
                        windowContent.querySelector('#complexBtn').addEventListener('click', () => {
                            openComplexTool();
                            windowContent.querySelector('#mathMenuModal').style.display = 'none';
                        });
                        
                        windowContent.querySelector('#fractalBtn').addEventListener('click', () => {
                            openFractalTool();
                            windowContent.querySelector('#mathMenuModal').style.display = 'none';
                        });
                        
                        // Function to create the grid
                        function createGrid() {
                            appState.squareSize = parseInt(windowContent.querySelector('#cellSize').value) || 70;
                            appState.numRows = parseInt(windowContent.querySelector('#gridRows').value) || 4;
                            appState.numCols = parseInt(windowContent.querySelector('#gridCols').value) || 4;
                            
                            // Hide setup, show grid
                            windowContent.querySelector('#setupPanel').style.display = 'none';
                            windowContent.querySelector('#gridContainer').style.display = 'block';
                            
                            // Create grid
                            drawGrid();
                            
                            // Update status
                            updateStatus('Grid created');
                        }
                        
                        // Function to draw the grid
                        function drawGrid() {
                            const grid = windowContent.querySelector('#grid');
                            grid.innerHTML = '';
                            
                            // Set grid template
                            grid.style.gridTemplateColumns = `repeat(${appState.numCols}, ${appState.squareSize}px)`;
                            
                            // Create cells
                            for (let i = 0; i < appState.numRows; i++) {
                                for (let j = 0; j < appState.numCols; j++) {
                                    const cell = document.createElement('div');
                                    cell.className = 'cell';
                                    cell.dataset.row = i;
                                    cell.dataset.col = j;
                                    
                                    // Add event listeners
                                    cell.addEventListener('click', handleCellClick);
                                    cell.addEventListener('contextmenu', handleCellRightClick);
                                    
                                    grid.appendChild(cell);
                                }
                            }
                        }
                        
                        // Handle cell click
                        function handleCellClick(e) {
                            const cell = e.currentTarget;
                            const row = parseInt(cell.dataset.row);
                            const col = parseInt(cell.dataset.col);
                            const subRow = cell.dataset.subrow !== undefined ? parseInt(cell.dataset.subrow) : undefined;
                            const subCol = cell.dataset.subcol !== undefined ? parseInt(cell.dataset.subcol) : undefined;
                            
                            openCellProperties(row, col, subRow, subCol);
                        }
                        
                        // Handle cell right click
                        function handleCellRightClick(e) {
                            e.preventDefault();
                            
                            const cell = e.currentTarget;
                            const row = parseInt(cell.dataset.row);
                            const col = parseInt(cell.dataset.col);
                            
                            const key = `${row}_${col}`;
                            
                            if (appState.splitSquares[key]) {
                                // If already split, merge
                                if (confirm('Merge this cell?')) {
                                    mergeCell(row, col);
                                }
                            } else {
                                // If not split, offer to split
                                const splitSize = prompt('Enter split size (rows,cols):', '2,2');
                                if (splitSize) {
                                    const [rows, cols] = splitSize.split(',').map(Number);
                                    if (rows > 0 && cols > 0) {
                                        splitCell(row, col, rows, cols);
                                    }
                                }
                            }
                        }
                        
                        // Open cell properties
                        function openCellProperties(row, col, subRow, subCol) {
                            const key = subRow !== undefined && subCol !== undefined ? 
                                      `${row}_${col}_${subRow}_${subCol}` : `${row}_${col}`;
                            
                            const cellData = appState.squareData[key] || {};
                            
                            // Populate form
                            windowContent.querySelector('#cellText').value = cellData.text || '';
                            windowContent.querySelector('#cellExpression').value = cellData.expression || '';
                            windowContent.querySelector('#cellBgColor').value = cellData.color || '#222222';
                            windowContent.querySelector('#cellFontSize').value = cellData.fontSize || 12;
                            windowContent.querySelector('#fontSizeValue').textContent = cellData.fontSize || 12;
                            windowContent.querySelector('#cellFontColor').value = cellData.fontColor || '#33ff33';
                            
                            // Store current cell
                            appState.currentCell = { row, col, subRow, subCol };
                            
                            // Show modal
                            windowContent.querySelector('#cellModal').style.display = 'block';
                        }
                        
                        // Apply cell properties
                        function applyCellProperties() {
                            if (!appState.currentCell) return;
                            
                            const { row, col, subRow, subCol } = appState.currentCell;
                            const key = subRow !== undefined && subCol !== undefined ? 
                                      `${row}_${col}_${subRow}_${subCol}` : `${row}_${col}`;
                            
                            // Get form values
                            const text = windowContent.querySelector('#cellText').value;
                            const expression = windowContent.querySelector('#cellExpression').value;
                            const color = windowContent.querySelector('#cellBgColor').value;
                            const fontSize = parseInt(windowContent.querySelector('#cellFontSize').value);
                            const fontColor = windowContent.querySelector('#cellFontColor').value;
                            
                            // Save previous state for undo
                            const prevState = appState.squareData[key] ? { ...appState.squareData[key] } : null;
                            appState.actionHistory.push({ key, prevState });
                            appState.redoStack = []; // Clear redo stack
                            
                            // Update data
                            appState.squareData[key] = {
                                text: text,
                                expression: expression,
                                color: color,
                                fontSize: fontSize,
                                fontColor: fontColor
                            };
                            
                            // Update display
                            updateCellDisplay(row, col, subRow, subCol);
                            
                            // Hide modal
                            windowContent.querySelector('#cellModal').style.display = 'none';
                            
                            // Update status
                            updateStatus('Cell updated');
                        }
                        
                        // Update cell display
                        function updateCellDisplay(row, col, subRow, subCol) {
                            let cell;
                            const key = subRow !== undefined && subCol !== undefined ? 
                                      `${row}_${col}_${subRow}_${subCol}` : `${row}_${col}`;
                            
                            if (subRow !== undefined && subCol !== undefined) {
                                // Find sub-cell
                                const mainCell = windowContent.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                                cell = mainCell.querySelector(`.sub-cell[data-subrow="${subRow}"][data-subcol="${subCol}"]`);
                            } else {
                                // Find main cell
                                cell = windowContent.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                            }
                            
                            if (!cell) return;
                            
                            const cellData = appState.squareData[key] || {};
                            
                            // Apply styling
                            cell.style.backgroundColor = cellData.color || '#222222';
                            cell.style.color = cellData.fontColor || '#33ff33';
                            cell.style.fontSize = `${cellData.fontSize || 12}px`;
                            
                            // Set content
                            let displayText = cellData.text || '';
                            
                            // Evaluate expression
                            if (cellData.expression) {
                                try {
                                    // Basic expression evaluation
                                    const expr = cellData.expression
                                        .replace(/sin\(/g, 'Math.sin(')
                                        .replace(/cos\(/g, 'Math.cos(')
                                        .replace(/tan\(/g, 'Math.tan(')
                                        .replace(/sqrt\(/g, 'Math.sqrt(')
                                        .replace(/abs\(/g, 'Math.abs(')
                                        .replace(/pi/g, 'Math.PI')
                                        .replace(/\^/g, '**');
                                    
                                    const result = eval(expr);
                                    displayText = String(result);
                                } catch (e) {
                                    displayText = "Error";
                                    console.error("Expression error:", e);
                                }
                            }
                            
                            cell.textContent = displayText;
                        }
                        
                        // Split a cell
                        function splitCell(row, col, rows, cols) {
                            const key = `${row}_${col}`;
                            
                            // Save state for undo
                            appState.actionHistory.push({
                                type: 'split',
                                key: key,
                                prevState: {
                                    isSplit: false,
                                    data: appState.squareData[key]
                                }
                            });
                            appState.redoStack = [];
                            
                            // Mark as split
                            appState.splitSquares[key] = { rows, cols };
                            
                            // Get the cell
                            const cell = windowContent.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                            cell.classList.add('split');
                            cell.innerHTML = '';
                            cell.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                            
                            // Create sub-cells
                            for (let i = 0; i < rows; i++) {
                                for (let j = 0; j < cols; j++) {
                                    const subCell = document.createElement('div');
                                    subCell.className = 'sub-cell';
                                    subCell.dataset.row = row;
                                    subCell.dataset.col = col;
                                    subCell.dataset.subrow = i;
                                    subCell.dataset.subcol = j;
                                    
                                    // Add event listeners
                                    subCell.addEventListener('click', handleCellClick);
                                    
                                    cell.appendChild(subCell);
                                }
                            }
                            
                            updateStatus('Cell split');
                        }
                        
                        // Merge a split cell
                        function mergeCell(row, col) {
                            const key = `${row}_${col}`;
                            
                            if (!appState.splitSquares[key]) return;
                            
                            // Save state for undo
                            const subCells = {};
                            const subCellElements = windowContent.querySelectorAll(`.cell[data-row="${row}"][data-col="${col}"] .sub-cell`);
                            
                            subCellElements.forEach(subCell => {
                                const subRow = parseInt(subCell.dataset.subrow);
                                const subCol = parseInt(subCell.dataset.subcol);
                                const subKey = `${row}_${col}_${subRow}_${subCol}`;
                                subCells[subKey] = appState.squareData[subKey];
                            });
                            
                            appState.actionHistory.push({
                                type: 'merge',
                                key: key,
                                prevState: {
                                    isSplit: true,
                                    splitInfo: { ...appState.splitSquares[key] },
                                    subCells: subCells
                                }
                            });
                            appState.redoStack = [];
                            
                            // Remove split flag
                            delete appState.splitSquares[key];
                            
                            // Remove sub-cell data
                            Object.keys(appState.squareData).forEach(dataKey => {
                                if (dataKey.startsWith(`${key}_`)) {
                                    delete appState.squareData[dataKey];
                                }
                            });
                            
                            // Reset cell
                            const cell = windowContent.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                            cell.classList.remove('split');
                            cell.innerHTML = '';
                            cell.style.removeProperty('grid-template-columns');
                            
                            // Update display
                            updateCellDisplay(row, col);
                            
                            updateStatus('Cell merged');
                        }
                        
                        // Undo function
                        function undo() {
                            if (appState.actionHistory.length === 0) {
                                alert('Nothing to undo');
                                return;
                            }
                            
                            const action = appState.actionHistory.pop();
                            
                            if (action.type === 'split') {
                                // Undo split (merge the cell)
                                const [row, col] = action.key.split('_').map(Number);
                                
                                // Save current state for redo
                                const subCells = {};
                                const subCellElements = windowContent.querySelectorAll(`.cell[data-row="${row}"][data-col="${col}"] .sub-cell`);
                                
                                subCellElements.forEach(subCell => {
                                    const subRow = parseInt(subCell.dataset.subrow);
                                    const subCol = parseInt(subCell.dataset.subcol);
                                    const subKey = `${row}_${col}_${subRow}_${subCol}`;
                                    subCells[subKey] = appState.squareData[subKey];
                                });
                                
                                appState.redoStack.push({
                                    type: 'split',
                                    key: action.key,
                                    redoState: {
                                        isSplit: true,
                                        splitInfo: { ...appState.splitSquares[action.key] },
                                        subCells: subCells
                                    }
                                });
                                
                                // Merge the cell
                                mergeCell(row, col);
                                
                                // Restore previous cell state
                                if (action.prevState.data) {
                                    appState.squareData[action.key] = action.prevState.data;
                                    updateCellDisplay(row, col);
                                }
                            } else if (action.type === 'merge') {
                                // Undo merge (re-split the cell)
                                const [row, col] = action.key.split('_').map(Number);
                                
                                // Save current state for redo
                                appState.redoStack.push({
                                    type: 'merge',
                                    key: action.key,
                                    redoState: {
                                        isSplit: false,
                                        data: appState.squareData[action.key]
                                    }
                                });
                                
                                // Restore the split
                                const splitInfo = action.prevState.splitInfo;
                                splitCell(row, col, splitInfo.rows, splitInfo.cols);
                                
                                // Restore sub-cell data
                                for (let subKey in action.prevState.subCells) {
                                    if (action.prevState.subCells[subKey]) {
                                        appState.squareData[subKey] = action.prevState.subCells[subKey];
                                        
                                        // Extract sub-row and sub-col from key
                                        const [_, __, subRow, subCol] = subKey.split('_').map(Number);
                                        updateCellDisplay(row, col, subRow, subCol);
                                    }
                                }
                            } else {
                                // Regular cell update
                                const key = action.key;
                                let row, col, subRow, subCol;
                                
                                if (key.split('_').length === 4) {
                                    [row, col, subRow, subCol] = key.split('_').map(Number);
                                } else {
                                    [row, col] = key.split('_').map(Number);
                                }
                                
                                // Save current state for redo
                                appState.redoStack.push({
                                    key: key,
                                    redoState: { ...appState.squareData[key] }
                                });
                                
								// Restore previous state
                                if (action.prevState) {
                                    appState.squareData[key] = action.prevState;
                                } else {
                                    delete appState.squareData[key];
                                }
                                
                                // Update display
                                updateCellDisplay(row, col, subRow, subCol);
                            }
                            
                            updateStatus('Undo completed');
                        }
                        
                        // Redo function
                        function redo() {
                            if (appState.redoStack.length === 0) {
                                alert('Nothing to redo');
                                return;
                            }
                            
                            const action = appState.redoStack.pop();
                            
                            if (action.type === 'split') {
                                // Redo split
                                const [row, col] = action.key.split('_').map(Number);
                                
                                // Save current state for undo
                                appState.actionHistory.push({
                                    type: 'split',
                                    key: action.key,
                                    prevState: {
                                        isSplit: false,
                                        data: appState.squareData[action.key]
                                    }
                                });
                                
                                // Redo the split
                                const splitInfo = action.redoState.splitInfo;
                                splitCell(row, col, splitInfo.rows, splitInfo.cols);
                                
                                // Restore sub-cell data
                                for (let subKey in action.redoState.subCells) {
                                    if (action.redoState.subCells[subKey]) {
                                        appState.squareData[subKey] = action.redoState.subCells[subKey];
                                        
                                        // Extract sub-row and sub-col from key
                                        const [_, __, subRow, subCol] = subKey.split('_').map(Number);
                                        updateCellDisplay(row, col, subRow, subCol);
                                    }
                                }
                            } else if (action.type === 'merge') {
                                // Redo merge
                                const [row, col] = action.key.split('_').map(Number);
                                
                                // Save current state for undo
                                const subCells = {};
                                const subCellElements = windowContent.querySelectorAll(`.cell[data-row="${row}"][data-col="${col}"] .sub-cell`);
                                
                                subCellElements.forEach(subCell => {
                                    const subRow = parseInt(subCell.dataset.subrow);
                                    const subCol = parseInt(subCell.dataset.subcol);
                                    const subKey = `${row}_${col}_${subRow}_${subCol}`;
                                    subCells[subKey] = appState.squareData[subKey];
                                });
                                
                                appState.actionHistory.push({
                                    type: 'merge',
                                    key: action.key,
                                    prevState: {
                                        isSplit: true,
                                        splitInfo: { ...appState.splitSquares[action.key] },
                                        subCells: subCells
                                    }
                                });
                                
                                // Merge the cell
                                mergeCell(row, col);
                                
                                // Restore cell state
                                if (action.redoState.data) {
                                    appState.squareData[action.key] = action.redoState.data;
                                    updateCellDisplay(row, col);
                                }
                            } else {
                                // Regular cell update
                                const key = action.key;
                                let row, col, subRow, subCol;
                                
                                if (key.split('_').length === 4) {
                                    [row, col, subRow, subCol] = key.split('_').map(Number);
                                } else {
                                    [row, col] = key.split('_').map(Number);
                                }
                                
                                // Save current state for undo
                                appState.actionHistory.push({
                                    key: key,
                                    prevState: appState.squareData[key] ? { ...appState.squareData[key] } : null
                                });
                                
                                // Restore redo state
                                appState.squareData[key] = action.redoState;
                                
                                // Update display
                                updateCellDisplay(row, col, subRow, subCol);
                            }
                            
                            updateStatus('Redo completed');
                        }
                        
                        // Save grid to file
                        function saveGrid() {
                            // Create a data object with all grid info
                            const gridData = {
                                squareData: appState.squareData,
                                splitSquares: appState.splitSquares,
                                numRows: appState.numRows,
                                numCols: appState.numCols,
                                squareSize: appState.squareSize
                            };
                            
                            // Ask for filename
                            const fileName = prompt("Enter filename to save:", "grid.json");
                            if (!fileName) return;
                            
                            // Attempt to save to VintageOS filesystem
                            try {
                                const fullPath = `/Documents/${fileName}`;
                                VintageOS.fs.writeFile(fullPath, JSON.stringify(gridData, null, 2));
                                updateStatus(`Grid saved to ${fullPath}`);
                            } catch (error) {
                                alert(`Error saving grid: ${error.message}`);
                                updateStatus('Error saving grid');
                            }
                        }
                        
                        // Load grid from file
                        function loadGrid() {
                            // Show a simple file picker with documents
                            const files = VintageOS.fs.listFiles('/Documents');
                            
                            if (!files || files.length === 0) {
                                alert('No files found in Documents folder');
                                return;
                            }
                            
                            let fileList = 'Select a file to load:\n\n';
                            files.forEach((file, index) => {
                                if (file.name.endsWith('.json')) {
                                    fileList += `${index + 1}. ${file.name}\n`;
                                }
                            });
                            
                            const fileIndex = prompt(fileList + '\nEnter file number:');
                            if (!fileIndex) return;
                            
                            const selectedFile = files[parseInt(fileIndex) - 1];
                            if (!selectedFile) {
                                alert('Invalid selection');
                                return;
                            }
                            
                            try {
                                const content = VintageOS.fs.readFile(selectedFile.path);
                                if (!content) {
                                    throw new Error('File is empty');
                                }
                                
                                const gridData = JSON.parse(content);
                                
                                // Validate data structure
                                if (!gridData.squareData || !gridData.numRows || !gridData.numCols) {
                                    throw new Error('Invalid grid data format');
                                }
                                
                                // Load the data
                                appState.squareData = gridData.squareData;
                                appState.splitSquares = gridData.splitSquares || {};
                                appState.numRows = gridData.numRows;
                                appState.numCols = gridData.numCols;
                                appState.squareSize = gridData.squareSize;
                                
                                // Clear history
                                appState.actionHistory = [];
                                appState.redoStack = [];
                                
                                // Switch to grid view
                                windowContent.querySelector('#setupPanel').style.display = 'none';
                                windowContent.querySelector('#gridContainer').style.display = 'block';
                                
                                // Draw the grid
                                drawGrid();
                                
                                // Update cell displays
                                for (let key in appState.squareData) {
                                    let row, col, subRow, subCol;
                                    
                                    if (key.split('_').length === 4) {
                                        [row, col, subRow, subCol] = key.split('_').map(Number);
                                        
                                        // Make sure parent cell is split
                                        const parentKey = `${row}_${col}`;
                                        if (appState.splitSquares[parentKey]) {
                                            const cell = windowContent.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                                            if (!cell.classList.contains('split')) {
                                                const splitInfo = appState.splitSquares[parentKey];
                                                splitCell(row, col, splitInfo.rows, splitInfo.cols);
                                            }
                                        }
                                        
                                        updateCellDisplay(row, col, subRow, subCol);
                                    } else {
                                        [row, col] = key.split('_').map(Number);
                                        updateCellDisplay(row, col);
                                    }
                                }
                                
                                updateStatus(`Grid loaded from ${selectedFile.name}`);
                            } catch (error) {
                                alert(`Error loading grid: ${error.message}`);
                                updateStatus('Error loading grid');
                            }
                        }
                        
                        // Update status bar
                        function updateStatus(message) {
                            windowContent.querySelector('#statusBar').textContent = message;
                        }
                        
                        // Math tools functions
                        function openMatrixTool() {
                            const toolWin = VintageOS.windowManager.createWindow('Matrix Operations', 'matrixTool', 500, 400);
                            const toolContent = document.getElementById(`window-content-${toolWin}`);
                            
                            toolContent.innerHTML = `
                                <div style="padding: 15px;">
                                    <h3>Matrix Operations</h3>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label>Matrix Size: </label>
                                        <input type="number" id="matrixRows" min="1" max="5" value="3" style="width: 40px;"> √ó 
                                        <input type="number" id="matrixCols" min="1" max="5" value="3" style="width: 40px;">
                                        <button id="createMatrixBtn">Create</button>
                                    </div>
                                    
                                    <div id="matrixContainer" style="margin: 15px 0;"></div>
                                    
                                    <div id="operationsContainer" style="margin-top: 15px; display: none;">
                                        <label>Operation: </label>
                                        <select id="matrixOperation">
                                            <option value="determinant">Determinant</option>
                                            <option value="inverse">Inverse</option>
                                            <option value="transpose">Transpose</option>
                                            <option value="eigenvalues">Eigenvalues</option>
                                        </select>
                                        <button id="computeBtn">Compute</button>
                                    </div>
                                    
                                    <div id="resultContainer" style="margin-top: 15px; min-height: 100px; border: 1px solid var(--main-border); padding: 10px; display: none;"></div>
                                </div>
                            `;
                            
                            // Matrix creation
                            toolContent.querySelector('#createMatrixBtn').addEventListener('click', () => {
                                const rows = parseInt(toolContent.querySelector('#matrixRows').value);
                                const cols = parseInt(toolContent.querySelector('#matrixCols').value);
                                
                                if (rows < 1 || rows > 5 || cols < 1 || cols > 5) {
                                    alert('Matrix dimensions must be between 1 and 5');
                                    return;
                                }
                                
                                // Create matrix inputs
                                let html = '<table>';
                                
                                for (let i = 0; i < rows; i++) {
                                    html += '<tr>';
                                    for (let j = 0; j < cols; j++) {
                                        html += `<td><input type="number" id="matrix_${i}_${j}" value="${i === j ? 1 : 0}" style="width: 50px;"></td>`;
                                    }
                                    html += '</tr>';
                                }
                                
                                html += '</table>';
                                
                                toolContent.querySelector('#matrixContainer').innerHTML = html;
                                toolContent.querySelector('#operationsContainer').style.display = 'block';
                                toolContent.querySelector('#resultContainer').style.display = 'none';
                            });
                            
                            // Compute matrix operation
                            toolContent.querySelector('#computeBtn').addEventListener('click', () => {
                                const rows = parseInt(toolContent.querySelector('#matrixRows').value);
                                const cols = parseInt(toolContent.querySelector('#matrixCols').value);
                                const operation = toolContent.querySelector('#matrixOperation').value;
                                
                                // Create matrix from inputs
                                const matrix = [];
                                for (let i = 0; i < rows; i++) {
                                    const row = [];
                                    for (let j = 0; j < cols; j++) {
                                        const value = parseFloat(toolContent.querySelector(`#matrix_${i}_${j}`).value);
                                        row.push(isNaN(value) ? 0 : value);
                                    }
                                    matrix.push(row);
                                }
                                
                                // Perform operation
                                let result;
                                try {
                                    switch (operation) {
                                        case 'determinant':
                                            if (rows !== cols) {
                                                throw new Error('Matrix must be square for determinant');
                                            }
                                            result = computeDeterminant(matrix);
                                            break;
                                        case 'inverse':
                                            if (rows !== cols) {
                                                throw new Error('Matrix must be square for inverse');
                                            }
                                            result = computeInverse(matrix);
                                            break;
                                        case 'transpose':
                                            result = computeTranspose(matrix);
                                            break;
                                        case 'eigenvalues':
                                            if (rows !== cols) {
                                                throw new Error('Matrix must be square for eigenvalues');
                                            }
                                            result = 'Eigenvalue computation requires advanced mathematical libraries';
                                            break;
                                    }
                                    
                                    // Display result
                                    const resultContainer = toolContent.querySelector('#resultContainer');
                                    resultContainer.style.display = 'block';
                                    
                                    if (typeof result === 'number') {
                                        resultContainer.innerHTML = `<strong>Result:</strong> ${result}`;
                                    } else if (Array.isArray(result)) {
                                        let html = '<strong>Result:</strong><br><table>';
                                        for (let i = 0; i < result.length; i++) {
                                            html += '<tr>';
                                            for (let j = 0; j < result[i].length; j++) {
                                                html += `<td style="padding: 5px; border: 1px solid var(--main-border);">${result[i][j].toFixed(4)}</td>`;
                                            }
                                            html += '</tr>';
                                        }
                                        html += '</table>';
                                        resultContainer.innerHTML = html;
                                    } else {
                                        resultContainer.innerHTML = `<strong>Result:</strong> ${result}`;
                                    }
                                } catch (error) {
                                    toolContent.querySelector('#resultContainer').innerHTML = `<span style="color: red;">Error: ${error.message}</span>`;
                                    toolContent.querySelector('#resultContainer').style.display = 'block';
                                }
                            });
                            
                            // Matrix calculation functions
                            function computeDeterminant(matrix) {
                                const n = matrix.length;
                                
                                if (n === 1) {
                                    return matrix[0][0];
                                }
                                
                                if (n === 2) {
                                    return matrix[0][0] * matrix[1][1] - matrix[0][1] * matrix[1][0];
                                }
                                
                                if (n === 3) {
                                    return matrix[0][0] * (matrix[1][1] * matrix[2][2] - matrix[1][2] * matrix[2][1]) -
                                           matrix[0][1] * (matrix[1][0] * matrix[2][2] - matrix[1][2] * matrix[2][0]) +
                                           matrix[0][2] * (matrix[1][0] * matrix[2][1] - matrix[1][1] * matrix[2][0]);
                                }
                                
                                return "Determinant for matrices larger than 3x3 requires advanced libraries";
                            }
                            
                            function computeTranspose(matrix) {
                                const rows = matrix.length;
                                const cols = matrix[0].length;
                                const result = [];
                                
                                for (let j = 0; j < cols; j++) {
                                    result[j] = [];
                                    for (let i = 0; i < rows; i++) {
                                        result[j][i] = matrix[i][j];
                                    }
                                }
                                
                                return result;
                            }
                            
                            function computeInverse(matrix) {
                                const n = matrix.length;
                                
                                if (n === 1) {
                                    if (Math.abs(matrix[0][0]) < 1e-10) {
                                        throw new Error('Matrix is singular');
                                    }
                                    return [[1 / matrix[0][0]]];
                                }
                                
                                if (n === 2) {
                                    const det = matrix[0][0] * matrix[1][1] - matrix[0][1] * matrix[1][0];
                                    if (Math.abs(det) < 1e-10) {
                                        throw new Error('Matrix is singular');
                                    }
                                    
                                    return [
                                        [matrix[1][1] / det, -matrix[0][1] / det],
                                        [-matrix[1][0] / det, matrix[0][0] / det]
                                    ];
                                }
                                
                                return "Inverse for matrices larger than 2x2 requires advanced libraries";
                            }
                        }
                        
                        function openPlotTool() {
                            const toolWin = VintageOS.windowManager.createWindow('Function Plotter', 'plotTool', 500, 400);
                            const toolContent = document.getElementById(`window-content-${toolWin}`);
                            
                            toolContent.innerHTML = `
                                <div style="padding: 15px;">
                                    <h3>Function Plotter</h3>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label>Function f(x): </label>
                                        <input type="text" id="functionExpr" value="sin(x)" style="width: 200px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label>x range: </label>
                                        <input type="number" id="xMin" value="-10" style="width: 60px;"> to 
                                        <input type="number" id="xMax" value="10" style="width: 60px;">
                                    </div>
                                    
                                    <button id="plotBtn">Plot Function</button>
                                    
                                    <div style="margin-top: 15px; width: 100%; height: 250px; border: 1px solid var(--main-border);">
                                        <canvas id="plotCanvas" width="450" height="250" style="width: 100%; height: 100%;"></canvas>
                                    </div>
                                </div>
                            `;
                            
                            toolContent.querySelector('#plotBtn').addEventListener('click', () => {
                                const functionExpr = toolContent.querySelector('#functionExpr').value;
                                const xMin = parseFloat(toolContent.querySelector('#xMin').value);
                                const xMax = parseFloat(toolContent.querySelector('#xMax').value);
                                
                                plotFunction(functionExpr, xMin, xMax);
                            });
                            
                            function plotFunction(functionExpr, xMin, xMax) {
                                const canvas = toolContent.querySelector('#plotCanvas');
                                const ctx = canvas.getContext('2d');
                                
                                // Clear canvas
                                ctx.fillStyle = '#111';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                
                                // Draw axes
                                ctx.strokeStyle = '#444';
                                ctx.lineWidth = 1;
                                ctx.beginPath();
                                
                                // x-axis
                                const yMiddle = canvas.height / 2;
                                ctx.moveTo(0, yMiddle);
                                ctx.lineTo(canvas.width, yMiddle);
                                
                                // y-axis
                                const xMiddle = canvas.width / 2;
                                ctx.moveTo(xMiddle, 0);
                                ctx.lineTo(xMiddle, canvas.height);
                                
                                ctx.stroke();
                                
                                // Prepare function
                                const safeExpr = functionExpr
                                    .replace(/sin\(/g, 'Math.sin(')
                                    .replace(/cos\(/g, 'Math.cos(')
                                    .replace(/tan\(/g, 'Math.tan(')
                                    .replace(/sqrt\(/g, 'Math.sqrt(')
                                    .replace(/abs\(/g, 'Math.abs(')
                                    .replace(/pi/g, 'Math.PI')
                                    .replace(/\^/g, '**');
                                
                                // Calculate scaling factors
                                const xScale = canvas.width / (xMax - xMin);
                                const yScale = canvas.height / 20; // Assume y range of [-10, 10]
                                
                                // Plot function
                                ctx.strokeStyle = 'var(--main-text)';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                
                                let isFirstPoint = true;
                                
                                for (let px = 0; px < canvas.width; px++) {
                                    const x = xMin + (px / xScale);
                                    
                                    try {
                                        // Calculate y value
                                        const y = eval(safeExpr.replace(/x/g, x));
                                        
                                        if (isNaN(y) || !isFinite(y)) continue;
                                        
                                        // Convert to canvas coordinates
                                        const py = yMiddle - (y * yScale);
                                        
                                        if (isFirstPoint) {
                                            ctx.moveTo(px, py);
                                            isFirstPoint = false;
                                        } else {
                                            ctx.lineTo(px, py);
                                        }
                                    } catch (e) {
                                        continue;
                                    }
                                }
                                
                                ctx.stroke();
                                
                                // Add legend
                                ctx.fillStyle = 'var(--main-text)';
                                ctx.font = '12px monospace';
                                ctx.fillText(`f(x) = ${functionExpr}`, 10, 20);
                            }
                        }
                        
                        function openVectorFieldTool() {
                            const toolWin = VintageOS.windowManager.createWindow('Vector Field', 'vectorTool', 500, 400);
                            const toolContent = document.getElementById(`window-content-${toolWin}`);
                            
                            toolContent.innerHTML = `
                                <div style="padding: 15px;">
                                    <h3>Vector Field Visualization</h3>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label>P(x,y): </label>
                                        <input type="text" id="vectorP" value="-y" style="width: 120px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label>Q(x,y): </label>
                                        <input type="text" id="vectorQ" value="x" style="width: 120px;">
                                    </div>
                                    
                                    <button id="plotVectorBtn">Plot Vector Field</button>
                                    
                                    <div style="margin-top: 15px; width: 100%; height: 250px; border: 1px solid var(--main-border);">
                                        <canvas id="vectorCanvas" width="450" height="250" style="width: 100%; height: 100%;"></canvas>
                                    </div>
                                </div>
                            `;
                            
                            toolContent.querySelector('#plotVectorBtn').addEventListener('click', () => {
                                const pExpr = toolContent.querySelector('#vectorP').value;
                                const qExpr = toolContent.querySelector('#vectorQ').value;
                                
                                plotVectorField(pExpr, qExpr);
                            });
                            
                            function plotVectorField(pExpr, qExpr) {
                                const canvas = toolContent.querySelector('#vectorCanvas');
                                const ctx = canvas.getContext('2d');
                                
                                // Clear canvas
                                ctx.fillStyle = '#111';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                
                                // Draw axes
                                ctx.strokeStyle = '#444';
                                ctx.lineWidth = 1;
                                ctx.beginPath();
                                
                                // x-axis
                                const yMiddle = canvas.height / 2;
                                ctx.moveTo(0, yMiddle);
                                ctx.lineTo(canvas.width, yMiddle);
                                
                                // y-axis
                                const xMiddle = canvas.width / 2;
                                ctx.moveTo(xMiddle, 0);
                                ctx.lineTo(xMiddle, canvas.height);
                                
                                ctx.stroke();
                                
                                // Prepare expressions
                                const safePExpr = pExpr
                                    .replace(/sin\(/g, 'Math.sin(')
                                    .replace(/cos\(/g, 'Math.cos(')
                                    .replace(/tan\(/g, 'Math.tan(')
                                    .replace(/sqrt\(/g, 'Math.sqrt(')
                                    .replace(/abs\(/g, 'Math.abs(')
                                    .replace(/pi/g, 'Math.PI')
                                    .replace(/\^/g, '**');
                                    
                                const safeQExpr = qExpr
                                    .replace(/sin\(/g, 'Math.sin(')
                                    .replace(/cos\(/g, 'Math.cos(')
                                    .replace(/tan\(/g, 'Math.tan(')
                                    .replace(/sqrt\(/g, 'Math.sqrt(')
                                    .replace(/abs\(/g, 'Math.abs(')
                                    .replace(/pi/g, 'Math.PI')
                                    .replace(/\^/g, '**');
                                
                                // Draw vector field
                                ctx.strokeStyle = 'var(--main-text)';
                                ctx.lineWidth = 1;
                                
                                const gridSize = 20;
                                const xScale = canvas.width / gridSize;
                                const yScale = canvas.height / gridSize;
                                
                                for (let i = 0; i < gridSize; i++) {
                                    for (let j = 0; j < gridSize; j++) {
                                        // Calculate grid point coordinates
                                        const x = (i - gridSize / 2) * 10 / gridSize;
                                        const y = (gridSize / 2 - j) * 10 / gridSize;
                                        
                                        try {
                                            // Calculate vector components
                                            const p = eval(safePExpr.replace(/x/g, x).replace(/y/g, y));
                                            const q = eval(safeQExpr.replace(/x/g, x).replace(/y/g, y));
                                            
                                            if (isNaN(p) || !isFinite(p) || isNaN(q) || !isFinite(q)) continue;
                                            
                                            // Calculate vector magnitude
                                            const magnitude = Math.sqrt(p*p + q*q);
                                            if (magnitude < 0.001) continue;
                                            
                                            // Normalize and scale
                                            const scale = 0.4;
                                            const nx = p / magnitude * scale;
                                            const ny = q / magnitude * scale;
                                            
                                            // Convert to canvas coordinates
                                            const px = i * xScale;
                                            const py = j * yScale;
                                            
                                            // Draw vector
                                            ctx.beginPath();
                                            ctx.moveTo(px, py);
                                            ctx.lineTo(px + nx * xScale, py - ny * yScale);
                                            
                                            // Draw arrowhead
                                            const arrowSize = 3;
                                            const angle = Math.atan2(-ny, nx);
                                            ctx.lineTo(
                                                px + nx * xScale - arrowSize * Math.cos(angle - Math.PI/6),
                                                py - ny * yScale + arrowSize * Math.sin(angle - Math.PI/6)
                                            );
                                            ctx.moveTo(px + nx * xScale, py - ny * yScale);
                                            ctx.lineTo(
                                                px + nx * xScale - arrowSize * Math.cos(angle + Math.PI/6),
                                                py - ny * yScale + arrowSize * Math.sin(angle + Math.PI/6)
                                            );
                                            
                                            ctx.stroke();
                                        } catch (e) {
                                            continue;
                                        }
                                    }
                                }
                                
                                // Add legend
                                ctx.fillStyle = 'var(--main-text)';
                                ctx.font = '12px monospace';
                                ctx.fillText(`P(x,y) = ${pExpr}`, 10, 20);
                                ctx.fillText(`Q(x,y) = ${qExpr}`, 10, 40);
                            }
                        }
                        
                        function openComplexTool() {
                            const toolWin = VintageOS.windowManager.createWindow('Complex Function', 'complexTool', 500, 400);
                            const toolContent = document.getElementById(`window-content-${toolWin}`);
                            
                            toolContent.innerHTML = `
                                <div style="padding: 15px;">
                                    <h3>Complex Function Visualization</h3>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label>Function f(z): </label>
                                        <input type="text" id="complexExpr" value="z^2" style="width: 200px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <select id="complexType">
                                            <option value="z^2">z^2</option>
                                            <option value="z^3">z^3</option>
                                            <option value="1/z">1/z</option>
                                            <option value="exp(z)">e^z</option>
                                            <option value="custom">Custom (advanced)</option>
                                        </select>
                                    </div>
                                    
                                    <button id="visualizeBtn">Visualize</button>
                                    
                                    <div style="margin-top: 15px; width: 100%; height: 250px; border: 1px solid var(--main-border);">
                                        <canvas id="complexCanvas" width="450" height="250" style="width: 100%; height: 100%;"></canvas>
                                    </div>
                                </div>
                            `;
                            
                            // Sync dropdown with input
                            toolContent.querySelector('#complexType').addEventListener('change', function() {
                                if (this.value !== 'custom') {
                                    toolContent.querySelector('#complexExpr').value = this.value;
                                }
                            });
                            
                            toolContent.querySelector('#visualizeBtn').addEventListener('click', () => {
                                const functionExpr = toolContent.querySelector('#complexExpr').value;
                                visualizeComplex(functionExpr);
                            });
                            
                            function visualizeComplex(functionExpr) {
                                const canvas = toolContent.querySelector('#complexCanvas');
                                const ctx = canvas.getContext('2d');
                                const width = canvas.width;
                                const height = canvas.height;
                                
                                // Create image data
                                const imageData = ctx.createImageData(width, height);
                                const data = imageData.data;
                                
                                // Function to evaluate complex number based on expression
                                function evaluateComplex(expr, re, im) {
                                    // Simple implementations for common functions
                                    if (expr === 'z^2') {
                                        // (a+bi)^2 = a^2-b^2 + 2abi
                                        return [re*re - im*im, 2*re*im];
                                    } else if (expr === 'z^3') {
                                        // (a+bi)^3
                                        const re2 = re*re - im*im;
                                        const im2 = 2*re*im;
                                        return [re2*re - im2*im, re2*im + im2*re];
                                    } else if (expr === '1/z') {
                                        // 1/(a+bi) = (a-bi)/(a^2+b^2)
                                        const denom = re*re + im*im;
                                        if (Math.abs(denom) < 1e-10) return [0, 0];
                                        return [re/denom, -im/denom];
                                    } else if (expr === 'exp(z)') {
                                        // e^(a+bi) = e^a * (cos(b) + i*sin(b))
                                        const expRe = Math.exp(re);
                                        return [expRe * Math.cos(im), expRe * Math.sin(im)];
                                    } else {
                                        // For custom expressions, fallback to z^2
                                        return [re*re - im*im, 2*re*im];
                                    }
                                }
                                
                                // Domain coloring algorithm
                                for (let j = 0; j < height; j++) {
                                    for (let i = 0; i < width; i++) {
                                        // Map pixel to complex plane
                                        const re = (i - width/2) * 4 / width;
                                        const im = (height/2 - j) * 4 / height;
                                        
                                        try {
                                            // Evaluate complex function
                                            const [resultRe, resultIm] = evaluateComplex(functionExpr, re, im);
                                            
                                            // Calculate magnitude and phase
                                            const magnitude = Math.sqrt(resultRe*resultRe + resultIm*resultIm);
                                            const phase = Math.atan2(resultIm, resultRe);
                                            
                                            // Domain coloring: use HSV color space
                                            // Hue from phase, saturation fixed, value from magnitude
                                            const h = ((phase + Math.PI) / (2 * Math.PI) * 360) % 360;
                                            const s = 1;
                                            const v = 1 - 1 / (1 + magnitude);
                                            
                                            // Convert HSV to RGB
                                            let r, g, b;
                                            const c = v * s;
                                            const x = c * (1 - Math.abs(((h / 60) % 2) - 1));
                                            const m = v - c;
                                            
                                            if (h < 60) { r = c; g = x; b = 0; }
                                            else if (h < 120) { r = x; g = c; b = 0; }
                                            else if (h < 180) { r = 0; g = c; b = x; }
                                            else if (h < 240) { r = 0; g = x; b = c; }
                                            else if (h < 300) { r = x; g = 0; b = c; }
                                            else { r = c; g = 0; b = x; }
                                            
                                            // Set pixel color
                                            const pos = (j * width + i) * 4;
                                            data[pos] = Math.round((r + m) * 255);
                                            data[pos + 1] = Math.round((g + m) * 255);
                                            data[pos + 2] = Math.round((b + m) * 255);
                                            data[pos + 3] = 255;
                                        } catch (e) {
                                            // Set black pixel on error
                                            const pos = (j * width + i) * 4;
                                            data[pos] = 0;
                                            data[pos + 1] = 0;
                                            data[pos + 2] = 0;
                                            data[pos + 3] = 255;
                                        }
                                    }
                                }
                                
                                // Draw the image
                                ctx.putImageData(imageData, 0, 0);
                                
                                // Add legend
                                ctx.fillStyle = 'white';
                                ctx.font = '12px monospace';
                                ctx.fillText(`f(z) = ${functionExpr}`, 10, 20);
                            }
                        }
                        
                        function openFractalTool() {
                            const toolWin = VintageOS.windowManager.createWindow('Fractal Generator', 'fractalTool', 500, 400);
                            const toolContent = document.getElementById(`window-content-${toolWin}`);
                            
                            toolContent.innerHTML = `
                                <div style="padding: 15px;">
                                    <h3>Fractal Generator</h3>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label>Fractal Type: </label>
                                        <select id="fractalType">
                                            <option value="mandelbrot">Mandelbrot Set</option>
                                            <option value="julia">Julia Set</option>
                                        </select>
                                    </div>
                                    
                                    <div id="juliaParamContainer" style="margin-bottom: 10px; display: none;">
                                        <label>Julia Parameter: </label>
                                        <input type="text" id="juliaParam" value="-0.7 + 0.27i" style="width: 120px;">
                                    </div>
                                    
                                    <div style="margin-bottom: 10px;">
                                        <label>Iterations: </label>
                                        <input type="number" id="fractalIterations" value="100" min="10" max="1000" style="width: 60px;">
                                    </div>
                                    
                                    <button id="generateFractalBtn">Generate</button>
                                    
                                    <div style="margin-top: 15px; width: 100%; height: 250px; border: 1px solid var(--main-border);">
                                        <canvas id="fractalCanvas" width="450" height="250" style="width: 100%; height: 100%;"></canvas>
                                    </div>
                                </div>
                            `;
                            
                            // Show/hide Julia parameters
                            toolContent.querySelector('#fractalType').addEventListener('change', function() {
                                toolContent.querySelector('#juliaParamContainer').style.display = 
                                    this.value === 'julia' ? 'block' : 'none';
                            });
                            
                            toolContent.querySelector('#generateFractalBtn').addEventListener('click', () => {
                                const fractalType = toolContent.querySelector('#fractalType').value;
                                const iterations = parseInt(toolContent.querySelector('#fractalIterations').value);
                                const juliaParam = toolContent.querySelector('#juliaParam').value;
                                
                                generateFractal(fractalType, iterations, juliaParam);
                            });
                            
                            function generateFractal(fractalType, iterations, juliaParam) {
                                const canvas = toolContent.querySelector('#fractalCanvas');
                                const ctx = canvas.getContext('2d');
                                const width = canvas.width;
                                const height = canvas.height;
                                
                                // Create image data
                                const imageData = ctx.createImageData(width, height);
                                const data = imageData.data;
                                
                                // Parse Julia set parameter if needed
                                let cx = -0.7, cy = 0.27;
                                if (fractalType === 'julia') {
                                    try {
                                        const match = juliaParam.match(/([+-]?\d*\.?\d*)\s*([+-])\s*(\d*\.?\d*)\s*i/);
                                        if (match) {
                                            cx = parseFloat(match[1]) || 0;
                                            cy = parseFloat((match[2] === '+' ? '' : '-') + match[3]) || 0;
                                        }
                                    } catch (e) {
                                        // Use defaults if parsing fails
                                    }
                                }
                                
                                // Generate fractal
                                for (let j = 0; j < height; j++) {
                                    for (let i = 0; i < width; i++) {
                                        let x0, y0, x, y;
                                        
                                        if (fractalType === 'mandelbrot') {
                                            // For Mandelbrot, initial point is the parameter
                                            x0 = (i - width * 0.7) * 3.5 / width;
                                            y0 = (j - height / 2) * 2.5 / height;
                                            x = 0;
                                            y = 0;
                                        } else {
                                            // For Julia, initial point is the pixel coordinate
                                            x = (i - width / 2) * 3 / width;
                                            y = (j - height / 2) * 3 / height;
                                            x0 = cx;
                                            y0 = cy;
                                        }
                                        
                                        // Iterate to check if point is in the set
                                        let iteration = 0;
                                        while (x*x + y*y < 4 && iteration < iterations) {
                                            const xtemp = x*x - y*y + x0;
                                            y = 2*x*y + y0;
                                            x = xtemp;
                                            iteration++;
                                        }
                                        
                                        // Color based on iteration count
                                        let r, g, b;
                                        if (iteration === iterations) {
                                            // Point is in the set
                                            r = g = b = 0;
                                        } else {
                                            // Smooth coloring
                                            const t = iteration + 1 - Math.log(Math.log(Math.sqrt(x*x + y*y))) / Math.log(2);
                                            const c = 3 * Math.log(t) / Math.log(iterations - 1);
                                            
                                            if (fractalType === 'mandelbrot') {
                                                if (c < 1) {
                                                    r = 0; g = Math.round(255 * c); b = 0;
                                                } else if (c < 2) {
                                                    r = 0; g = 255; b = Math.round(255 * (c - 1));
                                                } else {
                                                    r = Math.round(255 * (c - 2)); g = 255; b = 255;
                                                }
                                            } else {
                                                if (c < 1) {
                                                    r = Math.round(255 * c); g = 0; b = 0;
                                                } else if (c < 2) {
                                                    r = 255; g = Math.round(255 * (c - 1)); b = 0;
                                                } else {
                                                    r = 255; g = 255; b = Math.round(255 * (c - 2));
                                                }
                                            }
                                        }
                                        
                                        // Set pixel color
                                        const pos = (j * width + i) * 4;
                                        data[pos] = r;
                                        data[pos + 1] = g;
                                        data[pos + 2] = b;
                                        data[pos + 3] = 255;
                                    }
                                }
                                
                                // Draw the image
                                ctx.putImageData(imageData, 0, 0);
                                
                                // Add legend
                                ctx.fillStyle = 'white';
                                ctx.font = '12px monospace';
                                ctx.fillText(fractalType === 'mandelbrot' ? 'Mandelbrot Set' : 'Julia Set', 10, 20);
                                if (fractalType === 'julia') {
                                    ctx.fillText(`c = ${juliaParam}`, 10, 40);
                                }
                            }
                        }
                        
                        return windowId;
                    }
                },
                
                // File Manager
                fileManager: {
                    init: function(initialPath = '/') {
                        const windowId = VintageOS.windowManager.createWindow('File Manager', 'fileManager', 700, 500);
                        const windowContent = document.getElementById(`window-content-${windowId}`);
                        
                        // Initialize file manager state
                        const state = {
                            currentPath: initialPath,
                            selectedFile: null,
                            clipboardFile: null,
                            clipboardOperation: null, // 'cut' or 'copy'
                            viewMode: 'list', // 'list' or 'grid'
                            history: [initialPath],
                            historyIndex: 0
                        };
                        
                        // Set up the app content
                        let html = `
                            <div style="display: flex; flex-direction: column; height: 100%;">
                                <div style="padding: 5px; border-bottom: 1px solid var(--main-border);">
                                    <button id="backBtn" title="Back">‚Üê</button>
                                    <button id="forwardBtn" title="Forward">‚Üí</button>
                                    <button id="upBtn" title="Up">‚Üë</button>
                                    <button id="refreshBtn" title="Refresh">‚ü≥</button>
                                    <span style="margin: 0 10px;">Path:</span>
                                    <input type="text" id="pathInput" style="flex: 1; min-width: 200px;">
                                    <button id="goBtn">Go</button>
                                </div>
                                
                                <div style="display: flex; height: calc(100% - 70px);">
                                    <div id="sidePanel" style="width: 150px; border-right: 1px solid var(--main-border); overflow: auto; padding: 5px;">
                                        <div class="tree-item" data-path="/">Root</div>
                                        <div class="tree-item" data-path="/Desktop">Desktop</div>
                                        <div class="tree-item" data-path="/Documents">Documents</div>
                                        <div class="tree-item" data-path="/Applications">Applications</div>
                                        <div class="tree-item" data-path="/System">System</div>
                                    </div>
                                    
                                    <div id="fileListContainer" style="flex: 1; overflow: auto; padding: 5px;">
                                        <div id="fileList"></div>
                                    </div>
                                </div>
                                
                                <div style="padding: 5px; border-top: 1px solid var(--main-border); display: flex; justify-content: space-between;">
                                    <div>
                                        <button id="newFolderBtn">New Folder</button>
                                        <button id="newFileBtn">New File</button>
                                    </div>
                                    <div>
                                        <button id="cutBtn">Cut</button>
                                        <button id="copyBtn">Copy</button>
                                        <button id="pasteBtn">Paste</button>
                                        <button id="deleteBtn">Delete</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="fileContextMenu" style="display: none; position: absolute; background-color: var(--terminal-bg); border: 1px solid var(--main-border); z-index: 100;">
                                <div class="context-menu-item" id="openFileCtx">Open</div>
                                <div class="context-menu-item" id="renameFileCtx">Rename</div>
                                <div class="context-menu-item" id="cutFileCtx">Cut</div>
                                <div class="context-menu-item" id="copyFileCtx">Copy</div>
                                <div class="context-menu-item" id="deleteFileCtx">Delete</div>
                            </div>
                        `;
                        
                        windowContent.innerHTML = html;
                        
                        // Initialize path input
                        windowContent.querySelector('#pathInput').value = state.currentPath;
                        
                        // Load current directory
                        loadDirectory(state.currentPath);
                        
                        // Set up event handlers
                        windowContent.querySelector('#backBtn').addEventListener('click', () => {
                            navigateBack();
                        });
                        
                        windowContent.querySelector('#forwardBtn').addEventListener('click', () => {
                            navigateForward();
                        });
                        
                        windowContent.querySelector('#upBtn').addEventListener('click', () => {
                            navigateUp();
                        });
                        
                        windowContent.querySelector('#refreshBtn').addEventListener('click', () => {
                            loadDirectory(state.currentPath);
                        });
                        
                        windowContent.querySelector('#goBtn').addEventListener('click', () => {
                            const path = windowContent.querySelector('#pathInput').value;
                            navigateTo(path);
                        });
                        
                        windowContent.querySelector('#pathInput').addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                const path = e.target.value;
                                navigateTo(path);
                            }
                        });
                        
                        // Side panel navigation
                        windowContent.querySelectorAll('.tree-item').forEach(item => {
                            item.addEventListener('click', () => {
                                const path = item.dataset.path;
                                navigateTo(path);
                            });
                        });
                        
                        // File operations
                        windowContent.querySelector('#newFolderBtn').addEventListener('click', () => {
                            createNewFolder();
                        });
                        
                        windowContent.querySelector('#newFileBtn').addEventListener('click', () => {
                            createNewFile();
                        });
                        
                        windowContent.querySelector('#cutBtn').addEventListener('click', () => {
                            cutSelectedFile();
                        });
                        
                        windowContent.querySelector('#copyBtn').addEventListener('click', () => {
                            copySelectedFile();
                        });
                        
                        windowContent.querySelector('#pasteBtn').addEventListener('click', () => {
                            pasteFile();
                        });
                        
                        windowContent.querySelector('#deleteBtn').addEventListener('click', () => {
                            deleteSelectedFile();
                        });
                        
                        // Context menu
                        windowContent.querySelector('#openFileCtx').addEventListener('click', () => {
                            openSelectedFile();
                            hideContextMenu();
                        });
                        
                        windowContent.querySelector('#renameFileCtx').addEventListener('click', () => {
                            renameSelectedFile();
                            hideContextMenu();
                        });
                        
                        windowContent.querySelector('#cutFileCtx').addEventListener('click', () => {
                            cutSelectedFile();
                            hideContextMenu();
                        });
                        
                        windowContent.querySelector('#copyFileCtx').addEventListener('click', () => {
                            copySelectedFile();
                            hideContextMenu();
                        });
                        
                        windowContent.querySelector('#deleteFileCtx').addEventListener('click', () => {
                            deleteSelectedFile();
                            hideContextMenu();
                        });
                        
                        // Close context menu on click elsewhere
                        windowContent.addEventListener('click', (e) => {
                            if (!e.target.closest('#fileContextMenu')) {
                                hideContextMenu();
                            }
                        });
                        
                        // Function to load directory contents
                        function loadDirectory(path) {
                            state.currentPath = VintageOS.fs.normalizePath(path);
                            windowContent.querySelector('#pathInput').value = state.currentPath;
                            
                            const files = VintageOS.fs.listFiles(state.currentPath);
                            const fileList = windowContent.querySelector('#fileList');
                            
                            if (!files) {
                                fileList.innerHTML = '<div style="padding: 10px;">Directory not found or access denied.</div>';
                                return;
                            }
                            
                            // Sort files: folders first, then alphabetically
                            files.sort((a, b) => {
                                if (a.type === 'folder' && b.type !== 'folder') return -1;
                                if (a.type !== 'folder' && b.type === 'folder') return 1;
                                return a.name.localeCompare(b.name);
                            });
                            
                            // Clear and rebuild file list
                            fileList.innerHTML = '';
                            
                            if (state.viewMode === 'list') {
                                // List view
                                const table = document.createElement('table');
                                table.style.width = '100%';
                                table.style.borderCollapse = 'collapse';
                                
                                // Add header
                                const thead = document.createElement('thead');
                                thead.innerHTML = `
                                    <tr>
                                        <th style="text-align: left; padding: 5px;">Name</th>
                                        <th style="text-align: left; padding: 5px;">Type</th>
                                    </tr>
                                `;
                                table.appendChild(thead);
                                
                                // Add rows
                                const tbody = document.createElement('tbody');
                                
                                files.forEach(file => {
                                    const row = document.createElement('tr');
                                    row.className = 'file-item';
                                    row.dataset.path = file.path;
                                    row.dataset.type = file.type;
                                    
                                    row.innerHTML = `
                                        <td style="padding: 5px;">
                                            ${file.type === 'folder' ? 'üìÅ' : 'üìÑ'} ${file.name}
                                        </td>
                                        <td style="padding: 5px;">
                                            ${file.type === 'folder' ? 'Folder' : getFileType(file.name)}
                                        </td>
                                    `;
                                    
                                    row.addEventListener('click', () => selectFile(file.path));
                                    row.addEventListener('dblclick', () => openFile(file.path, file.type));
                                    row.addEventListener('contextmenu', (e) => showFileContextMenu(e, file.path));
                                    
                                    tbody.appendChild(row);
                                });
                                
                                table.appendChild(tbody);
                                fileList.appendChild(table);
                            } else {
                                // Grid view
                                const grid = document.createElement('div');
                                grid.style.display = 'flex';
                                grid.style.flexWrap = 'wrap';
                                grid.style.gap = '10px';
                                grid.style.padding = '5px';
                                
                                files.forEach(file => {
                                    const item = document.createElement('div');
                                    item.className = 'file-item';
                                    item.dataset.path = file.path;
                                    item.dataset.type = file.type;
                                    item.style.width = '80px';
                                    item.style.textAlign = 'center';
                                    item.style.padding = '5px';
                                    
                                    const icon = document.createElement('div');
                                    icon.style.fontSize = '24px';
                                    icon.style.marginBottom = '5px';
                                    icon.textContent = file.type === 'folder' ? 'üìÅ' : 'üìÑ';
                                    
                                    const name = document.createElement('div');
                                    name.style.wordBreak = 'break-word';
                                    name.style.fontSize = '12px';
                                    name.textContent = file.name;
                                    
                                    item.appendChild(icon);
                                    item.appendChild(name);
                                    
                                    item.addEventListener('click', () => selectFile(file.path));
                                    item.addEventListener('dblclick', () => openFile(file.path, file.type));
                                    item.addEventListener('contextmenu', (e) => showFileContextMenu(e, file.path));
                                    
                                    grid.appendChild(item);
                                });
                                
                                fileList.appendChild(grid);
                            }
                        }
                        
                        // Select a file
                        function selectFile(path) {
                            // Deselect previous selection
                            const prevSelected = windowContent.querySelector('.file-item.selected');
                            if (prevSelected) {
                                prevSelected.classList.remove('selected');
                            }
                            
                            // Select new file
                            const fileItem = windowContent.querySelector(`.file-item[data-path="${path}"]`);
                            if (fileItem) {
                                fileItem.classList.add('selected');
                                state.selectedFile = path;
                            }
                        }
                        
                        // Open a file or folder
                        function openFile(path, type) {
                            if (type === 'folder') {
                                navigateTo(path);
                            } else {
                                VintageOS.openFile(path);
                            }
                        }
                        
                        // Open the selected file
                        function openSelectedFile() {
                            if (!state.selectedFile) return;
                            
                            const fileItem = windowContent.querySelector(`.file-item[data-path="${state.selectedFile}"]`);
                            if (fileItem) {
                                const type = fileItem.dataset.type;
                                openFile(state.selectedFile, type);
                            }
                        }
                        
                        // Navigation functions
                        function navigateTo(path) {
                            const normalizedPath = VintageOS.fs.normalizePath(path);
                            
                            // Add to history if it's a new path
                            if (normalizedPath !== state.currentPath) {
                                if (state.historyIndex < state.history.length - 1) {
                                    // If we're not at the end of history, truncate it
                                    state.history = state.history.slice(0, state.historyIndex + 1);
                                }
                                
                                state.history.push(normalizedPath);
                                state.historyIndex = state.history.length - 1;
                            }
                            
                            loadDirectory(normalizedPath);
                        }
                        
                        function navigateBack() {
                            if (state.historyIndex > 0) {
                                state.historyIndex--;
                                loadDirectory(state.history[state.historyIndex]);
                            }
                        }
                        
                        function navigateForward() {
                            if (state.historyIndex < state.history.length - 1) {
                                state.historyIndex++;
                                loadDirectory(state.history[state.historyIndex]);
                            }
                        }
                        
                        function navigateUp() {
                            if (state.currentPath === '/') return;
                            
                            const parentPath = state.currentPath.substring(0, state.currentPath.lastIndexOf('/'));
                            navigateTo(parentPath || '/');
                        }
                        
                        // File operations
                        function createNewFolder() {
                            const folderName = prompt('Enter folder name:');
                            if (!folderName) return;
                            
                            try {
                                VintageOS.fs.createFolder(state.currentPath, folderName);
                                loadDirectory(state.currentPath);
                            } catch (error) {
                                alert(`Error creating folder: ${error.message}`);
                            }
                        }
                        
                        function createNewFile() {
                            const fileName = prompt('Enter file name:');
                            if (!fileName) return;
                            
                            try {
                                const filePath = `${state.currentPath}/${fileName}`;
                                VintageOS.fs.writeFile(filePath, '');
                                loadDirectory(state.currentPath);
                            } catch (error) {
                                alert(`Error creating file: ${error.message}`);
                            }
                        }
                        
                        function renameSelectedFile() {
                            if (!state.selectedFile) return;
                            
                            const oldName = state.selectedFile.split('/').pop();
                            const newName = prompt('Enter new name:', oldName);
                            
                            if (!newName || newName === oldName) return;
                            
                            try {
                                const parentPath = state.selectedFile.substring(0, state.selectedFile.lastIndexOf('/'));
                                const oldContent = VintageOS.fs.readFile(state.selectedFile);
                                const newPath = `${parentPath}/${newName}`;
                                
                                if (oldContent !== null) {
                                    // It's a file
                                    VintageOS.fs.writeFile(newPath, oldContent);
                                } else {
                                    // It's a folder - more complex to rename
                                    // For simplicity, we'll just show an error
                                    throw new Error('Folder renaming not supported');
                                }
                                
                                VintageOS.fs.deleteFile(state.selectedFile);
                                loadDirectory(state.currentPath);
                            } catch (error) {
                                alert(`Error renaming: ${error.message}`);
                            }
                        }
                        
                        function cutSelectedFile() {
                            if (!state.selectedFile) return;
                            
                            state.clipboardFile = state.selectedFile;
                            state.clipboardOperation = 'cut';
                        }
                        
                        function copySelectedFile() {
                            if (!state.selectedFile) return;
                            
                            state.clipboardFile = state.selectedFile;
                            state.clipboardOperation = 'copy';
                        }
                        
                        function pasteFile() {
                            if (!state.clipboardFile) return;
                            
                            try {
                                const fileName = state.clipboardFile.split('/').pop();
                                const newPath = `${state.currentPath}/${fileName}`;
                                
                                // Check if target exists
                                if (VintageOS.fs.fileExists(newPath)) {
                                    if (!confirm(`${newPath} already exists. Overwrite?`)) {
                                        return;
                                    }
                                }
                                
                                const content = VintageOS.fs.readFile(state.clipboardFile);
                                
                                if (content !== null) {
                                    // It's a file
                                    VintageOS.fs.writeFile(newPath, content);
                                    
                                    // If it was a cut operation, delete the original
                                    if (state.clipboardOperation === 'cut') {
                                        VintageOS.fs.deleteFile(state.clipboardFile);
                                        state.clipboardFile = null;
                                    }
                                    
                                    loadDirectory(state.currentPath);
                                } else {
                                    // It's a folder - more complex to copy
                                    throw new Error('Folder copy/paste not supported');
                                }
                            } catch (error) {
                                alert(`Error pasting file: ${error.message}`);
                            }
                        }
                        
                        function deleteSelectedFile() {
                            if (!state.selectedFile) return;
                            
                            if (!confirm(`Are you sure you want to delete ${state.selectedFile}?`)) {
                                return;
                            }
                            
                            try {
                                VintageOS.fs.deleteFile(state.selectedFile);
                                state.selectedFile = null;
                                loadDirectory(state.currentPath);
                            } catch (error) {
                                alert(`Error deleting: ${error.message}`);
                            }
                        }
                        
                        // Context menu
                        function showFileContextMenu(event, path) {
                            event.preventDefault();
                            
                            // Select the file
                            selectFile(path);
                            
                            // Position and show context menu
                            const contextMenu = windowContent.querySelector('#fileContextMenu');
                            contextMenu.style.left = `${event.pageX}px`;
                            contextMenu.style.top = `${event.pageY}px`;
                            contextMenu.style.display = 'block';
                        }
                        
                        function hideContextMenu() {
                            windowContent.querySelector('#fileContextMenu').style.display = 'none';
                        }
                        
                        // Helper functions
                        function getFileType(filename) {
                            const extension = filename.split('.').pop().toLowerCase();
                            
                            const typeMap = {
                                'txt': 'Text Document',
                                'json': 'JSON Document',
                                'js': 'JavaScript File',
                                'html': 'HTML Document',
                                'css': 'CSS Stylesheet',
                                'md': 'Markdown Document'
                            };
                            
                            return typeMap[extension] || 'File';
                        }
                        
                        return windowId;
                    }
                },
                
                // Terminal
                terminal: {
                    init: function() {
                        const windowId = VintageOS.windowManager.createWindow('Terminal', 'terminal', 600, 400);
                        const windowContent = document.getElementById(`window-content-${windowId}`);
                        
                        // Initialize terminal state
                        const state = {
                            currentDir: '/',
                            history: [],
                            historyIndex: -1,
                            commandsRun: 0
                        };
                        
                        // Set up the terminal UI
                        windowContent.innerHTML = `
                            <div class="terminal">
                                <div class="terminal-output" id="terminal-output">
                                    Welcome to VintageOS Terminal v1.0
                                    Type 'help' for a list of commands.
                                </div>
                                <div class="terminal-input-line">
                                    <span class="terminal-prompt">${state.currentDir} $</span>
                                    <input type="text" class="terminal-input" id="terminal-input" autofocus>
                                </div>
                            </div>
                        `;
                        
                        const terminalOutput = windowContent.querySelector('#terminal-output');
                        const terminalInput = windowContent.querySelector('#terminal-input');
                        
                        // Focus input when terminal is clicked
                        windowContent.querySelector('.terminal').addEventListener('click', () => {
                            terminalInput.focus();
                        });
                        
                        // Handle command input
                        terminalInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                const command = terminalInput.value.trim();
                                if (command) {
                                    processCommand(command);
                                    
                                    // Add to history
                                    state.history.push(command);
                                    state.historyIndex = state.history.length;
                                    
                                    // Clear input
                                    terminalInput.value = '';
                                }
                            } else if (e.key === 'ArrowUp') {
                                // Navigate history
                                if (state.historyIndex > 0) {
                                    state.historyIndex--;
                                    terminalInput.value = state.history[state.historyIndex];
                                }
                                e.preventDefault();
                            } else if (e.key === 'ArrowDown') {
                                // Navigate history
                                if (state.historyIndex < state.history.length - 1) {
                                    state.historyIndex++;
                                    terminalInput.value = state.history[state.historyIndex];
                                } else {
                                    state.historyIndex = state.history.length;
                                    terminalInput.value = '';
                                }
                                e.preventDefault();
                            } else if (e.key === 'Tab') {
                                // Tab completion
                                e.preventDefault();
                                tabComplete();
                            }
                        });
                        
                        // Process commands
                        function processCommand(command) {
                            // Write command to output
                            appendOutput(`<span style="color: var(--main-text);">${state.currentDir} $ ${command}</span>`);
                            state.commandsRun++;
                            
                            // Parse command and arguments
                            const parts = command.split(' ');
                            const cmd = parts[0].toLowerCase();
                            const args = parts.slice(1);
                            
                            // Execute command
                            try {
                                switch (cmd) {
                                    case 'help':
                                        showHelp();
                                        break;
                                    case 'ls':
                                    case 'dir':
                                        listDirectory(args[0]);
                                        break;
                                    case 'cd':
                                        changeDirectory(args[0]);
                                        break;
                                    case 'pwd':
                                        printWorkingDirectory();
                                        break;
                                    case 'cat':
                                    case 'type':
                                        showFileContent(args[0]);
                                        break;
                                    case 'mkdir':
                                        makeDirectory(args[0]);
                                        break;
                                    case 'touch':
                                    case 'new':
                                        createFile(args[0], args.slice(1).join(' '));
                                        break;
                                    case 'rm':
                                    case 'del':
                                        removeFile(args[0]);
                                        break;
                                    case 'clear':
                                    case 'cls':
                                        clearTerminal();
                                        break;
                                    case 'echo':
                                        echo(args.join(' '));
                                        break;
                                    case 'date':
                                        showDate();
                                        break;
                                    case 'whoami':
                                        whoami();
                                        break;
                                    case 'system':
                                        systemInfo();
                                        break;
                                    case 'exec':
                                        executeScript(args[0]);
                                        break;
                                    default:
                                        appendOutput(`Command not found: ${cmd}. Type 'help' for available commands.`);
                                }
                            } catch (error) {
                                appendOutput(`<span style="color: red;">Error: ${error.message}</span>`);
                            }
                            
                            // Scroll to bottom
                            terminalOutput.scrollTop = terminalOutput.scrollHeight;
                        }
                        
                        // Command implementations
                        function showHelp() {
                            appendOutput(`
                                Available commands:
                                - help: Show this help
                                - ls, dir [path]: List directory contents
                                - cd [path]: Change directory
                                - pwd: Print working directory
                                - cat, type [file]: Show file content
                                - mkdir [dir]: Create directory
                                - touch, new [file] [content]: Create file
                                - rm, del [file]: Remove file
                                - clear, cls: Clear terminal
                                - echo [text]: Display text
                                - date: Show current date/time
                                - whoami: Show current user
                                - system: Show system information
                                - exec [file]: Execute JavaScript file
                            `);
                        }
                        
                        function listDirectory(path) {
                            const targetPath = resolvePath(path || state.currentDir);
                            const files = VintageOS.fs.listFiles(targetPath);
                            
                            if (!files) {
                                appendOutput(`Directory not found: ${targetPath}`);
                                return;
                            }
                            
                            if (files.length === 0) {
                                appendOutput(`Directory is empty: ${targetPath}`);
                                return;
                            }
                            
                            // Sort files
                            files.sort((a, b) => {
                                if (a.type === 'folder' && b.type !== 'folder') return -1;
                                if (a.type !== 'folder' && b.type === 'folder') return 1;
                                return a.name.localeCompare(b.name);
                            });
                            
                            // Display files
                            let output = `Contents of ${targetPath}:\n`;
                            files.forEach(file => {
                                if (file.type === 'folder') {
                                    output += `<span style="color: #33aaff;">${file.name}/</span>\n`;
                                } else {
                                    output += `${file.name}\n`;
                                }
                            });
                            
                            appendOutput(output);
                        }
                        
                        function changeDirectory(path) {
                            if (!path) {
                                // Default to home
                                state.currentDir = '/';
                                updatePrompt();
                                return;
                            }
                            
                            const targetPath = resolvePath(path);
                            const files = VintageOS.fs.listFiles(targetPath);
                            
                            if (!files) {
                                appendOutput(`Directory not found: ${targetPath}`);
                                return;
                            }
                            
                            state.currentDir = targetPath;
                            updatePrompt();
                        }
                        
                        function printWorkingDirectory() {
                            appendOutput(state.currentDir);
                        }
                        
                        function showFileContent(path) {
                            if (!path) {
                                appendOutput('Usage: cat [file]');
                                return;
                            }
                            
                            const targetPath = resolvePath(path);
                            const content = VintageOS.fs.readFile(targetPath);
                            
                            if (content === null) {
                                appendOutput(`File not found or is a directory: ${targetPath}`);
                                return;
                            }
                            
                            appendOutput(`Content of ${targetPath}:\n${content}`);
                        }
                        
                        function makeDirectory(path) {
                            if (!path) {
                                appendOutput('Usage: mkdir [dir]');
                                return;
                            }
                            
                            const parts = path.split('/');
                            const dirName = parts.pop();
                            const parentPath = parts.length > 0 ? resolvePath(parts.join('/')) : state.currentDir;
                            
                            try {
                                VintageOS.fs.createFolder(parentPath, dirName);
                                appendOutput(`Directory created: ${dirName}`);
                            } catch (error) {
                                throw new Error(`Failed to create directory: ${error.message}`);
                            }
                        }
                        
                        function createFile(path, content = '') {
                            if (!path) {
                                appendOutput('Usage: touch [file] [content]');
                                return;
                            }
                            
                            const targetPath = resolvePath(path);
                            
                            try {
                                VintageOS.fs.writeFile(targetPath, content);
                                appendOutput(`File created: ${targetPath}`);
                            } catch (error) {
                                throw new Error(`Failed to create file: ${error.message}`);
                            }
                        }
                        
                        function removeFile(path) {
                            if (!path) {
                                appendOutput('Usage: rm [file]');
                                return;
                            }
                            
                            const targetPath = resolvePath(path);
                            
                            try {
                                VintageOS.fs.deleteFile(targetPath);
                                appendOutput(`Deleted: ${targetPath}`);
                            } catch (error) {
                                throw new Error(`Failed to delete: ${error.message}`);
                            }
                        }
                        
                        function clearTerminal() {
                            terminalOutput.innerHTML = '';
                        }
                        
                        function echo(text) {
                            appendOutput(text);
                        }
                        
                        function showDate() {
                            const now = new Date();
                            appendOutput(now.toString());
                        }
                        
                        function whoami() {
                            appendOutput('User: Guest');
                        }
                        
                        function systemInfo() {
                            const uptime = formatUptime(Date.now() - VintageOS.state.systemStartTime);
                            
                            appendOutput(`
                                System: ${VintageOS.name} v${VintageOS.version}
                                Uptime: ${uptime}
                                Commands run: ${state.commandsRun}
                                Current theme: ${VintageOS.config.theme}
                                Apps installed: ${VintageOS.config.installedApps.length + Object.keys(VintageOS.builtInApps).length}
                            `);
                        }
                        
                        function executeScript(path) {
                            if (!path) {
                                appendOutput('Usage: exec [file.js]');
                                return;
                            }
                            
                            const targetPath = resolvePath(path);
                            const content = VintageOS.fs.readFile(targetPath);
                            
                            if (content === null) {
                                appendOutput(`File not found or is a directory: ${targetPath}`);
                                return;
                            }
                            
                            if (!targetPath.endsWith('.js')) {
                                appendOutput('Only .js files can be executed');
                                return;
                            }
                            
                            try {
                                // Create a sandboxed environment
                                const scriptOutput = [];
                                const sandboxConsole = {
                                    log: (...args) => scriptOutput.push(args.join(' ')),
                                    error: (...args) => scriptOutput.push(`<span style="color: red;">${args.join(' ')}</span>`),
                                    warn: (...args) => scriptOutput.push(`<span style="color: yellow;">${args.join(' ')}</span>`)
                                };
                                
                                const sandboxEnv = {
                                    console: sandboxConsole,
                                    setTimeout: setTimeout,
                                    clearTimeout: clearTimeout,
                                    setInterval: setInterval,
                                    clearInterval: clearInterval,
                                    Date: Date,
                                    Math: Math,
                                    JSON: JSON,
                                    terminal: {
                                        write: (text) => scriptOutput.push(text),
                                        getPath: () => state.currentDir,
                                        fs: {
                                            readFile: (path) => VintageOS.fs.readFile(resolvePath(path)),
                                            writeFile: (path, content) => VintageOS.fs.writeFile(resolvePath(path), content),
                                            listFiles: (path) => VintageOS.fs.listFiles(resolvePath(path))
                                        }
                                    }
                                };
                                
                                // Execute the script with the sandbox
                                const scriptFunction = new Function(...Object.keys(sandboxEnv), content);
                                scriptFunction(...Object.values(sandboxEnv));
                                
                                // Display output
                                if (scriptOutput.length > 0) {
                                    appendOutput(`Script output:\n${scriptOutput.join('\n')}`);
                                } else {
                                    appendOutput('Script executed successfully (no output)');
                                }
                            } catch (error) {
                                appendOutput(`<span style="color: red;">Script error: ${error.message}</span>`);
                            }
                        }
                        
                        // Tab completion
                        function tabComplete() {
                            const input = terminalInput.value;
                            const lastWord = input.split(' ').pop();
                            
                            if (!lastWord) return;
                            
                            // Path completion
                            if (lastWord.includes('/')) {
                                const parts = lastWord.split('/');
                                const pathPart = parts.slice(0, -1).join('/');
                                const namePart = parts[parts.length - 1];
                                
                                const path = resolvePath(pathPart || '/');
                                const files = VintageOS.fs.listFiles(path);
                                
                                if (files) {
                                    const matches = files.filter(file => file.name.startsWith(namePart));
                                    
                                    if (matches.length === 1) {
                                        // Complete the match
                                        const completion = matches[0].name + (matches[0].type === 'folder' ? '/' : '');
                                        terminalInput.value = input.substring(0, input.length - lastWord.length) + 
                                                             (pathPart ? pathPart + '/' : '') + completion;
                                    } else if (matches.length > 1) {
                                        // Show options
                                        appendOutput(`\nMatching files in ${path}:`);
                                        matches.forEach(file => {
                                            appendOutput(`${file.name}${file.type === 'folder' ? '/' : ''}`);
                                        });
                                    }
                                }
                            } else {
                                // Current directory completion
                                const files = VintageOS.fs.listFiles(state.currentDir);
                                
                                if (files) {
                                    const matches = files.filter(file => file.name.startsWith(lastWord));
                                    
                                    if (matches.length === 1) {
                                        // Complete the match
                                        const completion = matches[0].name + (matches[0].type === 'folder' ? '/' : '');
                                        terminalInput.value = input.substring(0, input.length - lastWord.length) + completion;
                                    } else if (matches.length > 1) {
                                        // Show options
                                        appendOutput(`\nMatching files in ${state.currentDir}:`);
                                        matches.forEach(file => {
                                            appendOutput(`${file.name}${file.type === 'folder' ? '/' : ''}`);
                                        });
                                    }
                                }
                            }
                        }
                        
                        // Helper functions
                        function appendOutput(text) {
                            // Replace newlines with <br> tags
                            const formattedText = text.replace(/\n/g, '<br>');
                            terminalOutput.innerHTML += `<div>${formattedText}</div>`;
                            terminalOutput.scrollTop = terminalOutput.scrollHeight;
                        }
                        
                        function updatePrompt() {
                            windowContent.querySelector('.terminal-prompt').textContent = `${state.currentDir} $`;
                        }
                        
                        function resolvePath(path) {
                            if (!path) return state.currentDir;
                            
                            // Absolute path
                            if (path.startsWith('/')) {
                                return VintageOS.fs.normalizePath(path);
                            }
                            
                            // Relative path
                            let currentPath = state.currentDir;
                            
                            const parts = path.split('/');
                            for (const part of parts) {
                                if (part === '..') {
                                    // Go up one level
                                    const lastSlash = currentPath.lastIndexOf('/');
                                    if (lastSlash > 0) {
                                        currentPath = currentPath.substring(0, lastSlash);
                                    } else {
                                        currentPath = '/';
                                    }
                                } else if (part === '.' || part === '') {
                                    // Stay in current directory
                                    continue;
                                } else {
                                    // Go to subdirectory
                                    currentPath = `${currentPath}/${part}`;
                                }
                            }
                            
                            return VintageOS.fs.normalizePath(currentPath);
                        }
                        
                        function formatUptime(ms) {
                            const seconds = Math.floor(ms / 1000);
                            const minutes = Math.floor(seconds / 60);
                            const hours = Math.floor(minutes / 60);
                            const days = Math.floor(hours / 24);
                            
                            return `${days}d ${hours % 24}h ${minutes % 60}m ${seconds % 60}s`;
                        }
                        
                        return windowId;
                    }
                }
            }
        };
        
        // Initialize the OS
        document.addEventListener('DOMContentLoaded', function() {
            VintageOS.init();
            
            // Show a welcome notification
            setTimeout(() => {
                VintageOS.showNotification('Welcome to Vintage Mathematical OS v1.0');
            }, 1000);
        });
    </script>
</body>
</html>